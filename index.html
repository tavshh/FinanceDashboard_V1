<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mi Dashboard Financiero</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a0e1a">
<link rel="apple-touch-icon" href="icon-512.png">
<script src="chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0e1a;
    --surface: #111827;
    --surface2: #1a2235;
    --border: #1e2d45;
    --accent: #00e5ff;
    --accent2: #ff6b6b;
    --accent3: #ffd93d;
    --accent4: #6bcb77;
    --text: #e8eaf0;
    --muted: #5a6a85;
    --danger: #ff4757;
    --warning: #ffa502;
    --success: #2ed573;
    --hormiga: #f59e0b;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Mono', monospace, ui-monospace, 'Courier New'; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }
  body::before {
    content: ''; position: fixed; inset: 0;
    background-image: linear-gradient(rgba(0,229,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0,229,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px; pointer-events: none; z-index: 0;
  }
  .container { max-width: 1400px; margin: 0 auto; padding: 24px; position: relative; z-index: 1; min-width: 0; }
  header { display: flex; align-items: flex-end; justify-content: space-between; margin-bottom: 36px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
  h1 { font-family: 'DM Serif Display', serif, ui-serif, Georgia; font-size: 2.8rem; line-height: 1; outline:none; }
  h1 span { outline: none; transition: text-shadow 0.2s; }
  h1 span:focus { text-shadow: 0 0 8px rgba(0,229,255,0.4); }
  .date-badge { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 8px 16px; font-size: 0.75rem; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; }
  .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: 16px; margin-bottom: 32px; }
  .kpi { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; position: relative; overflow: hidden; transition: border-color 0.2s; }
  .kpi::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
  .kpi.cyan::before { background: var(--accent); }
  .kpi.red::before { background: var(--accent2); }
  .kpi.yellow::before { background: var(--accent3); }
  .kpi.green::before { background: var(--accent4); }
  .kpi.orange::before { background: var(--hormiga); }
  .kpi:hover { border-color: var(--muted); }
  .kpi-label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 8px; }
  .kpi-value { font-family: 'DM Serif Display', serif, ui-serif; font-size: 1.9rem; line-height: 1; margin-bottom: 6px; }
  .kpi.cyan .kpi-value { color: var(--accent); }
  .kpi.red .kpi-value { color: var(--accent2); }
  .kpi.yellow .kpi-value { color: var(--accent3); }
  .kpi.green .kpi-value { color: var(--accent4); }
  .kpi.orange .kpi-value { color: var(--hormiga); }
  .kpi-sub { font-size: 0.72rem; color: var(--muted); }
  .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
  .full-width { grid-column: 1 / -1; }
  
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 24px; min-width: 0; overflow-x: hidden; width: 100%; }
  .card-title { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
  .card-title::before { content: ''; display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: var(--accent); }
  
  .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 4px; display: block; }
  .item-list { width: 100%; border-collapse: collapse; min-width: 600px; }
  .item-list th { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); padding: 8px 10px; text-align: left; border-bottom: 1px solid var(--border); }
  .item-list td { padding: 10px 10px; font-size: 0.82rem; border-bottom: 1px solid rgba(30,45,69,0.5); vertical-align: middle; }
  .item-list tr:last-child td { border-bottom: none; }
  
  .editable-input { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: 'DM Mono', monospace; font-size: 0.82rem; padding: 6px 10px; width: 120px; text-align: right; transition: border-color 0.2s; }
  .editable-input:focus { outline: none; border-color: var(--accent); }
  .name-input { background: transparent; border: none; border-bottom: 1px dashed var(--border); color: var(--text); font-family: 'DM Mono', monospace; font-size: 0.82rem; padding: 2px 4px; width: 140px; }
  .name-input:focus { outline: none; border-color: var(--accent); }
  .freq-select, .cat-select { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--muted); font-family: 'DM Mono', monospace; font-size: 0.72rem; padding: 4px 8px; cursor: pointer; }
  .freq-select:focus, .cat-select:focus { outline: none; border-color: var(--accent); }
  .btn { background: transparent; border: 1px solid var(--border); border-radius: 6px; color: var(--muted); cursor: pointer; font-family: 'DM Mono', monospace; font-size: 0.72rem; padding: 6px 14px; transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.06em; }
  .btn:hover { border-color: var(--accent); color: var(--accent); }
  .btn-add { border-color: var(--accent); color: var(--accent); margin-top: 14px; }
  .btn-danger:hover { border-color: var(--danger); color: var(--danger); }
  .btn-primary { background: var(--accent); border-color: var(--accent); color: var(--bg); font-weight: 500; }
  .btn-primary:hover { opacity: 0.85; }
  .salary-row { display: flex; align-items: center; gap: 16px; background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 16px 20px; margin-bottom: 20px; transition: border-color 0.2s; cursor: pointer; flex-wrap: wrap; }
  .salary-row:hover { border-color: var(--accent); }
  .salary-label { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); flex: 1; min-width: 200px; }
  .salary-input { background: transparent; border: none; color: var(--accent4); font-family: 'DM Serif Display', serif; font-size: 1.4rem; padding: 0; text-align: right; width: 100%; max-width: 150px; }
  .progress-bar-wrap { background: var(--surface2); border-radius: 4px; height: 6px; overflow: hidden; margin-top: 6px; }
  .progress-bar { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
  
  .debt-item { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 12px; }
  .debt-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; flex-wrap: wrap; gap: 10px; }
  .debt-name { font-family: 'DM Serif Display', serif; font-size: 1.1rem; }
  .debt-total-badge { background: rgba(255,107,107,0.15); border: 1px solid rgba(255,107,107,0.3); border-radius: 6px; color: var(--accent2); font-size: 0.78rem; padding: 4px 10px; }
  .debt-fields { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 10px; }
  .debt-field label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); display: block; margin-bottom: 4px; }
  .debt-field input, .debt-field textarea { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: 'DM Mono', monospace; font-size: 0.85rem; padding: 7px 10px; width: 100%; transition: border-color 0.2s; }
  .debt-field input:focus, .debt-field textarea:focus { outline: none; border-color: var(--accent2); }
  .debt-field textarea { resize: vertical; min-height: 52px; font-size: 0.78rem; grid-column: 1 / -1; }
  
  .mode-toggle { display: flex; gap: 4px; margin-bottom: 14px; flex-wrap: wrap; }
  .mode-btn { flex: 1; background: var(--surface); border: 1px solid var(--border); border-radius: 7px; color: var(--muted); cursor: pointer; font-family: 'DM Mono', monospace; font-size: 0.68rem; padding: 7px 10px; text-align: center; transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.06em; min-width: 120px; }
  .mode-btn.active { background: var(--surface2); color: var(--accent2); border-color: var(--accent2); }
  
  .monthly-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-top: 10px; }
  .monthly-cell label { font-size: 0.6rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; display: block; margin-bottom: 3px; text-align: center; }
  .monthly-cell input { background: var(--surface); border: 1px solid var(--border); border-radius: 5px; color: var(--text); font-family: 'DM Mono', monospace; font-size: 0.78rem; padding: 5px 6px; width: 100%; text-align: center; transition: border-color 0.2s; }
  .monthly-cell input:focus { outline: none; border-color: var(--accent2); }
  .calc-badge { background: rgba(0,229,255,0.1); border: 1px solid rgba(0,229,255,0.2); border-radius: 6px; color: var(--accent); font-size: 0.72rem; padding: 6px 12px; display: inline-flex; align-items: center; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
  
  .health-ring { display: flex; align-items: center; justify-content: center; gap: 32px; padding: 20px 0; }
  .ring-wrap { position: relative; width: 140px; height: 140px; }
  .ring-label { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
  .ring-pct { font-family: 'DM Serif Display', serif; font-size: 2rem; line-height: 1; }
  .ring-sub { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 4px; }
  .health-details { flex: 1; width: 100%; }
  .health-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 0.82rem; }
  .health-row:last-child { border-bottom: none; }
  .health-row .label { color: var(--muted); }
  .health-row .val { font-family: 'DM Serif Display', serif; font-size: 1rem; }
  
  .chart-wrap { position: relative; height: 280px; width: 100%; }
  
  /* NUEVO: Estilos para el Calendario (Heatmap) */
  .cal-day {
    aspect-ratio: 1 / 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: default;
    border: 1px solid rgba(255,255,255,0.05);
    transition: transform 0.2s, border-color 0.2s;
  }
  .cal-day.has-data:hover { transform: scale(1.08); border-color: var(--hormiga); z-index: 2; cursor: help; }
  .cal-day.empty { background: var(--surface2); color: var(--muted); border-color: transparent; }
  .cal-day.level-1 { background: rgba(245,158,11,0.2); color: var(--text); }
  .cal-day.level-2 { background: rgba(245,158,11,0.4); color: var(--text); }
  .cal-day.level-3 { background: rgba(245,158,11,0.7); color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
  .cal-day.level-4 { background: var(--hormiga); color: #fff; box-shadow: 0 0 10px rgba(245,158,11,0.3); font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
  
  .timeline { overflow-x: auto; padding-bottom: 8px; width: 100%; }
  .timeline-grid { display: grid; min-width: 700px; border-radius: 8px; overflow: hidden; }
  .timeline-header { display: grid; background: var(--surface2); border-bottom: 1px solid var(--border); }
  .timeline-header div { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); padding: 8px 6px; text-align: center; border-right: 1px solid var(--border); }
  .timeline-row { display: grid; border-bottom: 1px solid rgba(30,45,69,0.5); }
  .timeline-row:last-child { border-bottom: none; }
  .timeline-row-name { font-size: 0.78rem; padding: 8px 10px; border-right: 1px solid var(--border); display: flex; align-items: center; gap: 6px; }
  .timeline-cell { font-size: 0.72rem; font-family: 'DM Mono', monospace; padding: 6px 4px; text-align: center; border-right: 1px solid rgba(30,45,69,0.5); }
  .cell-active { background: rgba(255,107,107,0.12); color: var(--accent2); }
  .cell-done { background: rgba(107,203,119,0.08); color: var(--accent4); }
  .cell-empty { color: var(--muted); }
  
  .hormiga-month-selector { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 16px; }
  .month-tab { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--muted); cursor: pointer; font-family: 'DM Mono', monospace; font-size: 0.68rem; padding: 6px 12px; transition: all 0.2s; text-transform: uppercase; }
  .month-tab.active { background: rgba(245,158,11,0.15); border-color: var(--hormiga); color: var(--hormiga); }
  .hormiga-cats { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
  .hormiga-cat-badge { background: var(--surface2); border: 1px solid var(--border); border-radius: 20px; font-size: 0.68rem; padding: 4px 12px; color: var(--muted); cursor: pointer; transition: all 0.2s; }
  .hormiga-cat-badge.active { border-color: var(--hormiga); color: var(--hormiga); }
  
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  
  /* KPI clickeable */
  .kpi.clickable { cursor: pointer; }
  .kpi.clickable:hover { border-color: var(--muted); transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.2); }
  .kpi.clickable:hover .kpi-nav-hint { opacity: 1; }
  .kpi-nav-hint { font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.08em; margin-top: 8px; opacity: 0; transition: opacity 0.2s; display: flex; align-items: center; gap: 4px; }
  .kpi.cyan .kpi-nav-hint  { color: var(--accent); }
  .kpi.orange .kpi-nav-hint { color: var(--hormiga); }
  .kpi.red .kpi-nav-hint   { color: var(--accent2); }
  /* Fila resumen (Total + Disponible) */
  .kpi-summary-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
  .kpi-summary-row .kpi { padding: 14px 18px; }
  .kpi-summary-row .kpi-value { font-size: 1.45rem; }
  /* Grid de KPIs navegables */
  .kpi-nav-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 32px; }
  @media (max-width: 700px) {
    .kpi-summary-row { grid-template-columns: 1fr 1fr; }
    .kpi-nav-grid { grid-template-columns: 1fr; gap: 10px; }
    .kpi-nav-grid .kpi { display: flex; align-items: center; padding: 14px 18px; gap: 14px; }
    .kpi-nav-grid .kpi::before { width: 4px; height: 40px; top: 50%; left: 0; right: auto; transform: translateY(-50%); border-radius: 0 4px 4px 0; }
    .kpi-nav-grid .kpi-label { margin-bottom: 2px; }
    .kpi-nav-grid .kpi-value { font-size: 1.5rem; margin-bottom: 0; }
    .kpi-nav-grid .kpi-body { flex: 1; }
    .kpi-nav-hint { margin-top: 0 !important; opacity: 1 !important; }
  }
  /* Barra de acciones secundarias */
  .secondary-nav { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
  .sec-btn {
    flex: 1; min-width: 100px;
    display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
    background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    color: var(--muted); cursor: pointer; font-family: 'DM Mono', monospace;
    font-size: 0.65rem; padding: 12px 8px; text-transform: uppercase; letter-spacing: 0.07em;
    transition: all 0.2s;
  }
  .sec-btn:hover { border-color: var(--muted); color: var(--text); background: var(--surface2); }
  .sec-btn.active { background: var(--surface2); border: 1px solid var(--border); }
  .sec-btn .sec-icon { font-size: 1.1rem; line-height: 1; }
  .sec-btn.graficas  { border-top: 3px solid var(--accent3); }
  .sec-btn.salud     { border-top: 3px solid var(--accent4); }
  .sec-btn.datos     { border-top: 3px solid var(--success); }
  .sec-btn.graficas.active, .sec-btn.graficas:hover  { border-top-color: var(--accent3); color: var(--accent3); }
  .sec-btn.salud.active,    .sec-btn.salud:hover     { border-top-color: var(--accent4); color: var(--accent4); }
  .sec-btn.datos.active,    .sec-btn.datos:hover     { border-top-color: var(--success); color: var(--success); }
  /* Tabs ocultos ‚Äî se mantiene la l√≥gica interna */
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  /* Income quick-add */
  .income-entry { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: var(--surface2); border-left: 3px solid var(--accent4); border-radius: 6px; margin-bottom: 8px; }
  .income-entry-name { font-size: 0.82rem; color: var(--text); }
  .income-entry-amount { font-family: 'DM Serif Display', serif; font-size: 1.05rem; color: var(--accent4); }
  .income-source-btn { background: var(--surface2); border: 1px solid rgba(107,203,119,0.25); border-radius: 20px; font-size: 0.72rem; padding: 5px 13px; color: var(--text); cursor: pointer; font-family: 'DM Mono', monospace; transition: all 0.18s; white-space: nowrap; }
  .income-source-btn:hover, .income-source-btn.active { background: rgba(107,203,119,0.12); border-color: var(--accent4); color: var(--accent4); }
  .alert { border-radius: 8px; padding: 12px 16px; font-size: 0.78rem; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
  .alert-danger { background: rgba(255,71,87,0.1); border: 1px solid rgba(255,71,87,0.3); color: var(--danger); }
  .alert-warning { background: rgba(255,165,2,0.1); border: 1px solid rgba(255,165,2,0.3); color: var(--warning); }
  .alert-success { background: rgba(46,213,115,0.1); border: 1px solid rgba(46,213,115,0.3); color: var(--success); }
  .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .refresh-btn { position: fixed; bottom: 24px; right: 24px; background: var(--accent); border: none; border-radius: 50%; color: var(--bg); cursor: pointer; font-size: 1.2rem; width: 52px; height: 52px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(0,229,255,0.3); transition: all 0.2s; z-index: 100; }
  .refresh-btn:hover { transform: scale(1.1); }
  
  .debt-pay-calendar { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; }
  .dpc-cell { display: flex; flex-direction: column; align-items: center; gap: 3px; min-width: 58px; flex: 1; max-width: 80px; }
  .dpc-label { font-size: 0.58rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); text-align: center; }
  .dpc-btn { width: 100%; border: 1px solid; border-radius: 6px; cursor: pointer; font-family: 'DM Mono', monospace; font-size: 0.62rem; padding: 5px 2px; text-align: center; transition: all 0.18s; }
  .dpc-btn.paid { background: rgba(46,213,115,0.15); border-color: var(--success); color: var(--success); }
  .dpc-btn.pending { background: rgba(255,107,107,0.1); border-color: var(--accent2); color: var(--accent2); }
  .dpc-btn.inactive { background: transparent; border-color: var(--border); color: var(--muted); cursor: default; }
  .debt-dates-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
  .debt-date-field { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; }
  .debt-date-field label { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); display: block; margin-bottom: 6px; }
  .debt-date-field input { background: transparent; border: none; color: var(--text); font-family: 'DM Mono', monospace; font-size: 1.1rem; width: 100%; text-align: center; padding: 0; }
  .debt-date-field input:focus { outline: none; }
  .debt-date-field .day-hint { font-size: 0.65rem; color: var(--muted); text-align: center; margin-top: 2px; }

  @media (max-width: 900px) { 
    .main-grid { grid-template-columns: 1fr; } 
    h1 { font-size: 2rem; } 
    .health-ring { flex-direction: column; } 
    .card { padding: 16px; } 
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <div style="font-size:0.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:6px;">Dashboard Financiero Personal</div>
      <h1 title="Haz clic para editar"><span contenteditable="true" spellcheck="false" onblur="saveData()">Mis</span> <span contenteditable="true" spellcheck="false" style="color:var(--accent); font-style:italic" onblur="saveData()">Finanzas</span></h1>
    </div>
    <div class="date-badge" id="date-badge"></div>
  </header>

  <div class="salary-row" onclick="goToTab('ingresos','tab-btn-ingresos')" title="Ir a Ingresos">
    <div style="display:flex;align-items:center;gap:10px;flex:1;min-width:0;">
      <span style="font-size:1.2rem;line-height:1;flex-shrink:0;">üí∞</span>
      <div style="min-width:0;">
        <div class="salary-label" style="min-width:unset;flex:unset;margin-bottom:2px;">Ingreso Total Mensual Neto</div>
        <div style="font-size:0.65rem;color:var(--muted);letter-spacing:0.06em;">Clic para gestionar fuentes</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;flex-shrink:0;">
      <div style="text-align:right;">
        <div class="salary-input" id="total-income-display" style="display:block;text-align:right;">$0.00</div>
        <div style="font-size:0.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;margin-top:2px;">MXN / mes</div>
      </div>
      <span style="color:var(--muted);font-size:0.75rem;">‚Üí</span>
    </div>
  </div>

  <!-- Fila superior: resumen (sin destino de navegaci√≥n) -->
  <div class="kpi-summary-row">
    <div class="kpi yellow">
      <div class="kpi-label">Total comprometido ¬∑ <span id="kpi-month-label" style="color:var(--accent3);font-style:normal;text-transform:none;letter-spacing:0;">‚Äî</span></div>
      <div class="kpi-value" id="kpi-total">$0</div>
      <div class="kpi-sub" id="kpi-pct">% del ingreso</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">Disponible estimado ¬∑ <span id="kpi-month-label2" style="color:var(--accent4);font-style:normal;text-transform:none;letter-spacing:0;">‚Äî</span></div>
      <div class="kpi-value" id="kpi-free">$0</div>
      <div class="kpi-sub" id="kpi-free-sub">ingresa tu sueldo arriba</div>
    </div>
  </div>

  <!-- KPIs navegables -->
  <div class="kpi-nav-grid">
    <div class="kpi cyan clickable" onclick="goToTab('gastos','tab-btn-gastos')" title="Ver gastos fijos">
      <div class="kpi-body">
        <div class="kpi-label">Gastos fijos / mes</div>
        <div class="kpi-value" id="kpi-fixed">$0</div>
        <div class="kpi-sub">suscripciones y servicios</div>
        <div class="kpi-nav-hint">Ver detalle ‚Üí</div>
      </div>
    </div>
    <div class="kpi orange clickable" onclick="goToTab('hormiga','tab-btn-hormiga')" title="Ver gastos hormiga">
      <div class="kpi-body">
        <div class="kpi-label">Gastos hormiga / mes</div>
        <div class="kpi-value" id="kpi-hormiga">$0</div>
        <div class="kpi-sub" id="kpi-hormiga-sub">mes actual</div>
        <div class="kpi-nav-hint">Ver detalle ‚Üí</div>
      </div>
    </div>
    <div class="kpi red clickable" onclick="goToTab('deudas','tab-btn-deudas')" title="Ver tarjetas de cr√©dito">
      <div class="kpi-body">
        <div class="kpi-label">Cuotas TDC / mes</div>
        <div class="kpi-value" id="kpi-debt">$0</div>
        <div class="kpi-sub">suma de mensualidades</div>
        <div class="kpi-nav-hint">Ver detalle ‚Üí</div>
      </div>
    </div>
  </div>

  <div id="health-alert" class="alert" style="display:none"></div>

  <!-- Barra de acciones secundarias -->
  <div class="secondary-nav">
    <button class="sec-btn graficas" id="tab-btn-graficas" onclick="goToTab('graficas','tab-btn-graficas')">
      <span class="sec-icon">üìä</span>Gr√°ficas
    </button>
    <button class="sec-btn salud" id="tab-btn-salud" onclick="goToTab('salud','tab-btn-salud')">
      <span class="sec-icon">‚ù§Ô∏è</span>Salud Financiera
    </button>
    <button class="sec-btn datos" id="tab-btn-datos" onclick="goToTab('datos','tab-btn-datos')">
      <span class="sec-icon">‚öôÔ∏è</span>Datos
    </button>
  </div>

  <div id="tab-datos" class="tab-content">
    <div class="card full-width">
      <div class="card-title">Gesti√≥n de Datos y Respaldos (Offline)</div>
      <p style="font-size:0.8rem; color:var(--muted); margin-bottom: 24px; line-height: 1.6;">
        Tus datos se guardan autom√°ticamente de forma invisible en la memoria interna de este navegador. 
        Si quieres utilizar esta herramienta en otro equipo (ej. de tu celular a tu PC), exporta tus datos aqu√≠ e imp√≥rtalos en el otro dispositivo.
      </p>
      <div style="display: flex; gap: 16px; flex-wrap: wrap;">
        <button class="btn btn-primary" style="padding: 10px 20px; font-size: 0.8rem;" onclick="exportData()">‚¨áÔ∏è Exportar Archivo (.json)</button>
        <label class="btn" style="padding: 10px 20px; font-size: 0.8rem; border-color:var(--accent4); color:var(--accent4); cursor: pointer;">
          ‚¨ÜÔ∏è Importar Archivo
          <input type="file" accept=".json" style="display:none;" onchange="importData(event)">
        </label>
      </div>
      <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border);">
        <p style="font-size:0.7rem; color:var(--danger); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em;">Zona de peligro</p>
        <button class="btn btn-danger" onclick="clearData()">üóëÔ∏è Borrar toda mi informaci√≥n</button>
      </div>
    </div>
  </div>

  <div id="tab-ingresos" class="tab-content">
    <div class="main-grid">
      <div class="card">
        <div class="card-title" style="color:var(--accent4);">üí∞ Captura de Ingresos</div>
        <div style="font-size:0.75rem;color:var(--muted);margin-bottom:16px;">Registra tus fuentes de dinero mensuales. Toca una fuente, ingresa el monto y guarda.</div>

        <!-- Fuentes como botones t√°ctiles + nueva fuente -->
        <div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center; margin-bottom:14px;">
          <div id="income-sources-container" style="display:flex; gap:6px; flex-wrap:wrap; flex:1;"></div>
          <button class="btn" style="padding:4px 10px; font-size:0.65rem; border-color:var(--accent4); color:var(--accent4); flex-shrink:0;" onclick="addIncomeSource()">+ Fuente</button>
        </div>

        <!-- Formulario -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px; padding-bottom:20px; border-bottom:1px dashed rgba(30,45,69,0.6);">
          <div style="grid-column:1/-1;">
            <input type="number" id="income-amount" inputmode="decimal" placeholder="$ Monto mensual"
              style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Mono',monospace;font-size:1.15rem;padding:12px 14px;width:100%;transition:border-color 0.2s;"
              onfocus="this.style.borderColor='var(--accent4)'" onblur="this.style.borderColor='var(--border)'"
              onkeydown="if(event.key==='Enter')document.getElementById('income-desc').focus()">
          </div>
          <div style="grid-column:1/-1;">
            <input type="text" id="income-desc" placeholder="Descripci√≥n (opcional)"
              style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.85rem;padding:10px 14px;width:100%;transition:border-color 0.2s;"
              onfocus="this.style.borderColor='var(--accent4)'" onblur="this.style.borderColor='var(--border)'"
              onkeydown="if(event.key==='Enter')saveIncomeQuick()">
          </div>
          <div style="grid-column:1/-1;">
            <button onclick="saveIncomeQuick()"
              style="width:100%;background:var(--accent4);border:none;border-radius:8px;color:#0a0e1a;font-family:'DM Mono',monospace;font-size:0.82rem;font-weight:600;padding:11px;cursor:pointer;text-transform:uppercase;letter-spacing:0.07em;transition:opacity 0.2s;"
              onmouseover="this.style.opacity='.85'" onmouseout="this.style.opacity='1'">
              Guardar Ingreso
            </button>
          </div>
        </div>

        <!-- Lista de ingresos registrados -->
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div style="font-size:0.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;">Fuentes registradas</div>
            <span style="font-family:'DM Serif Display',serif;font-size:1rem;color:var(--accent4);" id="total-income-display">$0.00</span>
          </div>
          <div id="income-entries-list"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Resumen</div>
        <div style="padding:20px 0;">
          <div class="health-row">
            <span class="label">Total ingresos / mes</span>
            <span class="val" style="color:var(--accent4)" id="income-summary-total">$0.00</span>
          </div>
          <div class="health-row">
            <span class="label">Fuentes registradas</span>
            <span class="val" id="income-summary-count">0</span>
          </div>
          <div class="health-row">
            <span class="label">Gastos comprometidos</span>
            <span class="val" style="color:var(--accent3)" id="income-summary-committed">$0.00</span>
          </div>
          <div class="health-row" style="border-bottom:none;">
            <span class="label">Disponible estimado</span>
            <span class="val" id="income-summary-free">$0.00</span>
          </div>
        </div>
        <div style="font-size:0.72rem;color:var(--muted);margin-top:12px;padding-top:12px;border-top:1px solid var(--border);line-height:1.6;">
          Tus datos se guardan autom√°ticamente en este dispositivo. Usa <strong style="color:var(--success);">‚öôÔ∏è Datos</strong> para exportar o importar tu informaci√≥n.
        </div>
      </div>
    </div>
  </div>

  <div id="tab-gastos" class="tab-content active">
    <div class="main-grid">
      <div class="card">
        <div class="card-title">Suscripciones &amp; Servicios</div>
        <div class="table-responsive">
          <table class="item-list">
            <thead><tr><th>Servicio</th><th>Categor√≠a</th><th>Frec.</th><th style="text-align:right">Monto</th><th></th></tr></thead>
            <tbody id="services-body"></tbody>
          </table>
        </div>
        <button class="btn btn-add" onclick="addService()">+ Agregar servicio</button>
      </div>
      <div class="card">
        <div class="card-title">Desglose por categor√≠a</div>
        <div class="chart-wrap"><canvas id="cat-chart"></canvas></div>
        <div id="cat-totals" style="margin-top:16px;font-size:0.78rem;"></div>
      </div>
    </div>
    <div class="card" style="margin-top:0">
      <div class="card-title" style="margin-bottom:14px;">Gestionar categor√≠as</div>
      <div id="cat-manager" style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;"></div>
      <button class="btn btn-add" style="margin-top:12px;" onclick="addUserCat()">+ Nueva categor√≠a</button>
    </div>
  </div>

  <div id="tab-hormiga" class="tab-content">
    <div class="main-grid">
      <div class="card">
        
        <div style="margin-bottom:24px; padding-bottom:16px; border-bottom: 1px dashed rgba(30,45,69,0.5);">
          <div class="card-title" style="margin-bottom:10px;">Registro de Gastos Hormiga</div>
          <div style="font-size:0.75rem;color:var(--muted);">Registra esos gastos peque√±os que se acumulan: caf√©, delivery, salidas casuales, etc. Selecciona la fecha exacta de cada movimiento.</div>
        </div>
        
        <div style="margin-bottom:24px; padding-bottom:16px; border-bottom: 1px dashed rgba(30,45,69,0.5);">
          <div style="font-size:0.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:12px;">Periodo activo</div>
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <button class="btn" style="padding:4px 10px;" onclick="shiftHormigaMonth(-1)">‚óÄ</button>
            <div class="hormiga-month-selector" id="hormiga-months" style="flex:1;margin:0;min-width:200px;"></div>
            <button class="btn" style="padding:4px 10px;" onclick="shiftHormigaMonth(1)">‚ñ∂</button>
          </div>
          <div style="display:flex;gap:6px;margin-top:12px;align-items:center;flex-wrap:wrap;">
            <span style="font-size:0.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;">Ir a:</span>
            <input type="month" id="hormiga-jump-month" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.72rem;padding:4px 8px;"
              onchange="jumpToHormigaMonth(this.value)">
            <span style="font-size:0.65rem;color:var(--muted);margin-left:8px;">o escribe:</span>
            <input type="text" id="hormiga-manual-month" placeholder="Ene 25" maxlength="6"
              style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.72rem;padding:4px 8px;width:70px;"
              onkeydown="if(event.key==='Enter')setHormigaMonthManual(this.value)">
          </div>
        </div>

        <!-- Categor√≠as como botones t√°ctiles -->
        <div style="margin-bottom:14px;">
          <div style="font-size:0.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Categor√≠a</div>
          <div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
            <div id="hormiga-cats-bar" style="display:flex; gap:6px; flex-wrap:wrap; flex:1;"></div>
            <button class="btn" style="padding:4px 10px; font-size:0.65rem; border-color:var(--hormiga); color:var(--hormiga); flex-shrink:0;" onclick="addHormigaCatBadge()">+ Nueva</button>
          </div>
        </div>

        <!-- Formulario de captura estilo ingresos -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px; padding-bottom:20px; border-bottom:1px dashed rgba(30,45,69,0.6);">
          <div style="grid-column:1/-1;">
            <input type="number" id="hormiga-amount" inputmode="decimal" placeholder="$ Monto del gasto"
              style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Mono',monospace;font-size:1.15rem;padding:12px 14px;width:100%;transition:border-color 0.2s;"
              onfocus="this.style.borderColor='var(--hormiga)'" onblur="this.style.borderColor='var(--border)'"
              onkeydown="if(event.key==='Enter')document.getElementById('hormiga-desc-input').focus()">
          </div>
          <div>
            <input type="text" id="hormiga-desc-input" placeholder="Descripci√≥n (opcional)"
              style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.85rem;padding:10px 14px;width:100%;transition:border-color 0.2s;"
              onfocus="this.style.borderColor='var(--hormiga)'" onblur="this.style.borderColor='var(--border)'"
              onkeydown="if(event.key==='Enter')saveHormigaQuick()">
          </div>
          <div>
            <input type="date" id="hormiga-date-input"
              style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.85rem;padding:10px 14px;width:100%;transition:border-color 0.2s;"
              onfocus="this.style.borderColor='var(--hormiga)'" onblur="this.style.borderColor='var(--border)'">
          </div>
          <div style="grid-column:1/-1;">
            <button onclick="saveHormigaQuick()"
              style="width:100%;background:var(--hormiga);border:none;border-radius:8px;color:#0a0e1a;font-family:'DM Mono',monospace;font-size:0.82rem;font-weight:600;padding:11px;cursor:pointer;text-transform:uppercase;letter-spacing:0.07em;transition:opacity 0.2s;"
              onmouseover="this.style.opacity='.85'" onmouseout="this.style.opacity='1'">
              Registrar Gasto
            </button>
          </div>
        </div>

        <!-- Lista de gastos registrados -->
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div style="font-size:0.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;">Gastos registrados</div>
            <span style="font-family:'DM Serif Display',serif;font-size:1rem;color:var(--hormiga);" id="hormiga-total-display">$0.00</span>
          </div>
          <div id="hormiga-entries-list"></div>
        </div>
      </div>
      
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
          <div class="card-title" style="margin-bottom:0;">Calendario de Actividad: <span id="hormiga-cal-title" style="margin-left:6px; color:var(--text); text-transform:none;"></span></div>
          <div style="display:flex;align-items:center;gap:6px;">
            <button class="btn" style="padding:4px 10px;border-color:var(--hormiga);color:var(--hormiga);" onclick="shiftHormigaMonth(-1)" title="Mes anterior">‚óÄ</button>
            <button class="btn" style="padding:4px 10px;border-color:var(--hormiga);color:var(--hormiga);" onclick="shiftHormigaMonth(1)" title="Mes siguiente">‚ñ∂</button>
          </div>
        </div>
        <div style="font-size:0.75rem;color:var(--muted);margin-bottom:16px;">Intensidad de gasto por d√≠a. Toca un d√≠a iluminado para ver el monto gastado.</div>
        <div id="hormiga-calendar-container" style="margin-bottom:24px;"></div>
        <div id="hormiga-summary" style="margin-top:16px;font-size:0.78rem; border-top:1px solid rgba(30,45,69,0.5); padding-top:16px;"></div>
      </div>
    </div>

    <div class="main-grid">
      <div class="card">
        <div class="card-title">Categor√≠as ‚Äî <span id="hormiga-cat-period-label">mes activo</span></div>
        <div class="chart-wrap" style="height:240px"><canvas id="hormiga-cat-chart"></canvas></div>
      </div>
      <div class="card">
        <div class="card-title">Comparativa personalizada</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end;margin-bottom:12px;">
          <div>
            <div style="font-size:0.62rem;color:var(--muted);margin-bottom:4px;">Desde</div>
            <input type="month" id="cmp-from" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.72rem;padding:5px 8px;">
          </div>
          <div>
            <div style="font-size:0.62rem;color:var(--muted);margin-bottom:4px;">Hasta</div>
            <input type="month" id="cmp-to" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.72rem;padding:5px 8px;">
          </div>
          <button class="btn" style="border-color:var(--accent);color:var(--accent);padding:5px 14px;" onclick="renderCompareChart()">Comparar</button>
        </div>
        <div class="chart-wrap" style="height:220px"><canvas id="hormiga-compare-chart"></canvas></div>
        <div id="cmp-summary" style="font-size:0.75rem;color:var(--muted);margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <div id="tab-deudas" class="tab-content">
    <div class="card full-width" style="margin-bottom:20px;">
      <div class="card-title">Calendario de Fechas TDC ‚Äî Mes Actual</div>
      <div style="font-size:0.75rem;color:var(--muted);margin-bottom:16px;">Vista r√°pida de cortes y fechas l√≠mite de pago de todas tus tarjetas este mes. Configura los d√≠as en cada tarjeta abajo.</div>
      <div id="tdc-dates-calendar" style="overflow-x:auto;-webkit-overflow-scrolling:touch;"></div>
    </div>
    <div class="card full-width">
      <div class="card-title">Tarjetas de Cr√©dito</div>
      <div id="debts-container"></div>
      <button class="btn btn-add" onclick="addDebt()">+ Agregar tarjeta</button>
    </div>
  </div>

  <div id="tab-graficas" class="tab-content">
    <!-- L√çNEA DE TIEMPO DE PAGOS MENSUALES -->
    <div class="card full-width" style="margin-bottom:20px;">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:4px;">
        <div class="card-title" style="margin-bottom:0;">Pagos totales por mes</div>
        <div style="display:flex;align-items:center;gap:8px;">
          <button class="btn" style="padding:5px 14px;border-color:var(--accent3);color:var(--accent3);" onclick="shiftPayTimeline(-1)" title="Mes anterior">‚óÄ</button>
          <span id="pay-tl-month-label" style="font-family:'DM Serif Display',serif;font-size:1.15rem;color:var(--accent3);min-width:90px;text-align:center;"></span>
          <button class="btn" style="padding:5px 14px;border-color:var(--accent3);color:var(--accent3);" onclick="shiftPayTimeline(1)" title="Mes siguiente">‚ñ∂</button>
        </div>
      </div>
      <div style="font-size:0.72rem;color:var(--muted);margin-bottom:16px;">Total comprometido: deudas fijas + cuotas TDC. Desliza para explorar meses.</div>

      <!-- Tarjeta de resumen del mes activo -->
      <div id="pay-tl-summary" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px;"></div>

      <!-- Scroll horizontal de meses -->
      <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:6px;">
        <div id="pay-tl-months-row" style="display:flex;gap:10px;min-width:max-content;padding:2px 2px 8px;"></div>
      </div>
    </div>

    <div class="main-grid">
      <div class="card">
        <div class="card-title">Distribuci√≥n total del gasto mensual</div>
        <div class="chart-wrap"><canvas id="dist-chart"></canvas></div>
      </div>
      <div class="card">
        <div class="card-title">Deuda TDC por tarjeta</div>
        <div class="chart-wrap"><canvas id="debt-chart"></canvas></div>
      </div>
      <div class="card full-width">
        <div class="card-title">Proyecci√≥n de pago de deudas (18 meses)</div>
        <div style="font-size:0.75rem;color:var(--muted);margin-bottom:12px;">Saldo restante por tarjeta mes a mes. Usa el scroll horizontal para explorar.</div>
        <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:4px;">
          <div style="min-width:640px;height:320px;position:relative;"><canvas id="proj-chart"></canvas></div>
        </div>
      </div>
      
      <div class="card full-width">
        <div class="card-title">Mapa de Evoluci√≥n Detallada por Categor√≠as</div>
        <div style="font-size:0.75rem;color:var(--muted);margin-bottom:12px;">Filtra por tipo de movimiento y ajusta el periodo para visualizar su comportamiento en el tiempo.</div>

        <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-end;margin-bottom:16px;">
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
            <label id="lbl-toggle-ingresos" style="display:flex;align-items:center;gap:4px;background:var(--surface2);padding:6px 12px;border-radius:6px;font-size:0.72rem;cursor:pointer;border:1px solid var(--accent);color:var(--accent);transition:all 0.2s;">
              <input type="checkbox" id="toggle-ingresos" checked onchange="renderAllExpensesChart()" style="display:none">
              üí∞ Ingresos
            </label>
            <label id="lbl-toggle-fijos" style="display:flex;align-items:center;gap:4px;background:var(--surface2);padding:6px 12px;border-radius:6px;font-size:0.72rem;cursor:pointer;border:1px solid var(--accent);color:var(--accent);transition:all 0.2s;">
              <input type="checkbox" id="toggle-fijos" checked onchange="renderAllExpensesChart()" style="display:none">
              üìÑ Gastos Fijos
            </label>
            <label id="lbl-toggle-tdc" style="display:flex;align-items:center;gap:4px;background:var(--surface2);padding:6px 12px;border-radius:6px;font-size:0.72rem;cursor:pointer;border:1px solid var(--accent);color:var(--accent);transition:all 0.2s;">
              <input type="checkbox" id="toggle-tdc" checked onchange="renderAllExpensesChart()" style="display:none">
              üí≥ Cuotas TDC
            </label>
            <label id="lbl-toggle-hormiga" style="display:flex;align-items:center;gap:4px;background:var(--surface2);padding:6px 12px;border-radius:6px;font-size:0.72rem;cursor:pointer;border:1px solid var(--accent);color:var(--accent);transition:all 0.2s;">
              <input type="checkbox" id="toggle-hormiga" checked onchange="renderAllExpensesChart()" style="display:none">
              üêú Hormiga
            </label>
          </div>
          <div style="flex:1"></div>
          <div style="display:flex;gap:8px;align-items:flex-end;">
            <div>
              <div style="font-size:0.62rem;color:var(--muted);margin-bottom:4px;">Desde</div>
              <input type="month" id="all-exp-from" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.72rem;padding:5px 8px;" onchange="renderAllExpensesChart()">
            </div>
            <div>
              <div style="font-size:0.62rem;color:var(--muted);margin-bottom:4px;">Hasta</div>
              <input type="month" id="all-exp-to" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.72rem;padding:5px 8px;" onchange="renderAllExpensesChart()">
            </div>
          </div>
        </div>

        <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:4px;">
          <div style="min-width:600px;height:400px;position:relative;"><canvas id="all-expenses-chart"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <div id="tab-timeline" class="tab-content">
    <div class="card full-width" style="margin-bottom:20px;">
      <div style="display:flex; justify-content:space-between; align-items:flex-end; flex-wrap:wrap; gap:16px; margin-bottom: 20px;">
        <div class="card-title" style="margin-bottom:0;">Calendario y Evoluci√≥n de Deudas</div>
        <div style="display:flex;gap:8px;align-items:flex-end;">
          <div>
            <div style="font-size:0.62rem;color:var(--muted);margin-bottom:4px;">Desde</div>
            <input type="month" id="tl-from" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.72rem;padding:5px 8px;" onchange="renderTimeline()">
          </div>
          <div>
            <div style="font-size:0.62rem;color:var(--muted);margin-bottom:4px;">Hasta</div>
            <input type="month" id="tl-to" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.72rem;padding:5px 8px;" onchange="renderTimeline()">
          </div>
        </div>
      </div>
      
      <div class="timeline">
        <div id="timeline-grid" class="timeline-grid"></div>
      </div>
      <div style="display:flex;gap:16px;margin-top:16px;font-size:0.72rem;align-items:center;">
        <span style="display:flex;align-items:center;gap:6px;"><span style="width:12px;height:12px;background:rgba(255,107,107,0.3);border-radius:3px;display:inline-block"></span> Pagando</span>
        <span style="display:flex;align-items:center;gap:6px;"><span style="width:12px;height:12px;background:rgba(107,203,119,0.15);border-radius:3px;display:inline-block"></span> Liquidado</span>
        <span style="display:flex;align-items:center;gap:6px;"><span style="width:12px;height:12px;background:rgba(255,255,255,0.04);border-radius:3px;display:inline-block"></span> Sin deuda</span>
      </div>
    </div>
    <div class="main-grid">
      <div class="card full-width">
        <div class="card-title">Gastos totales por mes (TDC + Fijos + Hormiga)</div>
        <div class="chart-wrap" style="height:300px"><canvas id="timeline-monthly-chart"></canvas></div>
      </div>
      <div class="card">
        <div class="card-title">Mes con mayor carga financiera</div>
        <div id="timeline-heaviest" style="font-size:0.82rem;"></div>
      </div>
      <div class="card">
        <div class="card-title">Gastos m√°s grandes por mes</div>
        <div id="timeline-biggest" style="font-size:0.82rem;"></div>
      </div>
    </div>
  </div>

  <div id="tab-salud" class="tab-content">
    <div class="main-grid">
      <div class="card">
        <div class="card-title">Indicador de salud financiera</div>
        <div class="health-ring">
          <div class="ring-wrap">
            <canvas id="health-ring-chart" width="140" height="140"></canvas>
            <div class="ring-label">
              <div class="ring-pct" id="health-pct">0%</div>
              <div class="ring-sub">Comprometido</div>
            </div>
          </div>
          <div class="health-details" id="health-details"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">M√©tricas clave</div>
        <div id="metrics-container"></div>
      </div>
      
      <div class="card full-width">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; flex-wrap:wrap; gap:16px; margin-bottom: 12px;">
          <div class="card-title" style="margin-bottom:0;">Comparativa de Gastos Totales</div>
          <div style="display:flex;gap:8px;align-items:flex-end;">
            <div>
              <div style="font-size:0.62rem;color:var(--muted);margin-bottom:4px;">Desde</div>
              <input type="month" id="health-cmp-from" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.72rem;padding:5px 8px;" onchange="renderHealthCompareChart()">
            </div>
            <div>
              <div style="font-size:0.62rem;color:var(--muted);margin-bottom:4px;">Hasta</div>
              <input type="month" id="health-cmp-to" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.72rem;padding:5px 8px;" onchange="renderHealthCompareChart()">
            </div>
          </div>
        </div>
        <div style="font-size:0.75rem;color:var(--muted);margin-bottom:12px;">Selecciona el periodo que deseas poner frente a frente:</div>
        <div class="chart-wrap" style="height:250px"><canvas id="health-compare-chart"></canvas></div>
      </div>

      <div class="card full-width">
        <div class="card-title">Recomendaciones</div>
        <div id="recommendations"></div>
      </div>
    </div>
  </div>
</div>

<button class="refresh-btn" onclick="recalculate()" title="Actualizar">‚ü≥</button>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  DATA DEFAULT (Se sobreescriben si hay datos guardados)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let incomes = [{id:1, name:'Sueldo Neto', amount: 0}];
let nextIncomeId = 2;

let userCats = [
  {id:'streaming',    label:'streaming',           color:'#a855f7'},
  {id:'almacenamiento',label:'almacenamiento',     color:'#00e5ff'},
  {id:'telecomunicaciones',label:'telecomunicaciones',color:'#f97316'},
  {id:'transporte',   label:'transporte',          color:'#ffd93d'},
  {id:'redes sociales',label:'redes sociales',     color:'#6bcb77'},
  {id:'servicios',    label:'servicios',            color:'#ff6b6b'},
  {id:'otro',         label:'otro',                color:'#94a3b8'},
];
let nextCatId = 10;
function getCatById(id) { return userCats.find(c=>c.id===id) || {id:'otro',label:'otro',color:'#94a3b8'}; }
function catColor(cat) { return getCatById(cat).color; }
function catLabel(cat) { return getCatById(cat).label; }

let services = [
  { id:1,  name:'YouTube Premium',  amount:172,    freq:'mensual',   cat:'streaming' },
  { id:2,  name:'Uber One',         amount:70,     freq:'mensual',   cat:'transporte' },
  { id:3,  name:'Apple Cloud',      amount:49,     freq:'mensual',   cat:'almacenamiento' },
  { id:4,  name:'HBO Max',          amount:167.30, freq:'mensual',   cat:'streaming' },
  { id:5,  name:'Amazon Prime',     amount:99,     freq:'mensual',   cat:'streaming' },
  { id:6,  name:'Google One',       amount:395,    freq:'mensual',   cat:'almacenamiento' },
  { id:7,  name:'Telmex',           amount:1108,   freq:'mensual',   cat:'telecomunicaciones' },
  { id:8,  name:'Spotify',          amount:239,    freq:'mensual',   cat:'streaming' },
  { id:9,  name:'Meli+',            amount:99,     freq:'mensual',   cat:'streaming' },
  { id:10, name:'Starlink',         amount:1000,   freq:'mensual',   cat:'telecomunicaciones' },
  { id:11, name:'Twitter/X',        amount:53,     freq:'mensual',   cat:'redes sociales' },
  { id:12, name:'Luz (CFE)',        amount:300,    freq:'bimestral', cat:'servicios' },
  { id:13, name:'Movistar',         amount:437,    freq:'mensual',   cat:'telecomunicaciones' },
];

let debts = [
  { id:1, name:'MercadoPago', total:10174.03, months:7, mode:'auto', autoSub:'months', fixedMonthly:0, color:'#00e5ff', note:'Pago fijo $1,583 marzo-julio.', monthlyAmounts:[], cutDay:0, payDay:0, payments:{} },
  { id:2, name:'Nu',          total:4787.56,  months:2, mode:'auto', autoSub:'months', fixedMonthly:0, color:'#a855f7', note:'Saldar en 2 meses.', monthlyAmounts:[], cutDay:0, payDay:0, payments:{} },
  { id:3, name:'Banamex',     total:15901.11, months:3, mode:'auto', autoSub:'months', fixedMonthly:0, color:'#f97316', note:'Pagos a 3 meses.', monthlyAmounts:[], cutDay:0, payDay:0, payments:{} },
  { id:4, name:'BBVA',        total:4038.48,  months:2, mode:'auto', autoSub:'months', fixedMonthly:0, color:'#3b82f6', note:'Saldar en 2 meses.', monthlyAmounts:[], cutDay:0, payDay:0, payments:{} },
  { id:5, name:'HSBC',        total:31230.86, months:8, mode:'auto', autoSub:'months', fixedMonthly:0, color:'#ef4444', note:'Compra compartida.', monthlyAmounts:[], cutDay:0, payDay:0, payments:{} },
];

let hormigaData = {};
for (let i=0; i<12; i++) {
  const d = new Date(2026, 2+i, 1);
  const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  hormigaData[key] = [];
}

let activeHormigaKey = '2026-03';
let nextHormigaId = 100;
let hormigaCatBadges = ['‚òï Caf√©','üçî Comida','üöó Uber','üõí Tienda','üéâ Salida','üì¶ Otro'];
let nextServiceId = 20;
let nextDebtId = 10;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CARGAR DATOS DESDE LOCALSTORAGE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadStoredData() {
  const stored = localStorage.getItem('finanzas_data');
  if (stored) {
    try {
      const p = JSON.parse(stored);
      if (p.incomes) incomes = p.incomes;
      if (p.userCats) userCats = p.userCats;
      if (p.services) services = p.services;
      if (p.debts) {
        debts = p.debts;
        // Migrate old debts without new fields
        debts.forEach(d => {
          if (d.cutDay === undefined) d.cutDay = 0;
          if (d.payDay === undefined) d.payDay = 0;
          if (d.payments === undefined) d.payments = {};
        });
      }
      if (p.hormigaData) hormigaData = p.hormigaData;
      if (p.hormigaCatBadges) hormigaCatBadges = p.hormigaCatBadges;
      if (p.nextIncomeId) nextIncomeId = p.nextIncomeId;
      if (p.nextCatId) nextCatId = p.nextCatId;
      if (p.nextServiceId) nextServiceId = p.nextServiceId;
      if (p.nextDebtId) nextDebtId = p.nextDebtId;
      if (p.nextHormigaId) nextHormigaId = p.nextHormigaId;
    } catch(e) { console.error('Error cargando los datos locales', e); }
  }
}
loadStoredData(); 

function saveData() {
  const dataToSave = {
    incomes, nextIncomeId, userCats, nextCatId, services, nextServiceId,
    debts, nextDebtId, hormigaData, hormigaCatBadges, nextHormigaId
  };
  localStorage.setItem('finanzas_data', JSON.stringify(dataToSave));
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  FUNCIONES DE IMPORTAR / EXPORTAR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportData() {
  const data = localStorage.getItem('finanzas_data') || JSON.stringify({ incomes, userCats, services, debts, hormigaData, hormigaCatBadges });
  const blob = new Blob([data], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `mis_finanzas_respaldo_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if(data.incomes || data.services || data.debts) {
        localStorage.setItem('finanzas_data', JSON.stringify(data));
        alert("¬°Datos importados con √©xito! La p√°gina se actualizar√° ahora.");
        location.reload();
      } else {
        alert("El archivo no parece ser un respaldo v√°lido de Mis Finanzas.");
      }
    } catch(err) {
      alert("Ocurri√≥ un error al leer el archivo. Aseg√∫rate de que es el archivo .json correcto.");
    }
  };
  reader.readAsText(file);
}

function clearData() {
  if(confirm("‚ö†Ô∏è ¬øEst√°s completamente seguro de que deseas BORRAR TODOS los datos? Esta acci√≥n eliminar√° todo tu registro y te devolver√° a la plantilla por defecto. ¬°No se puede deshacer!")) {
    localStorage.removeItem('finanzas_data');
    location.reload();
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  RESTO DEL C√ìDIGO (L√ìGICA GR√ÅFICA Y MATEM√ÅTICA)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MONTH_NAMES_SHORT = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
function getMonthLabel(index) {
  const baseYear = 2026, baseMonth = 2; 
  const absMonth = baseMonth + index;
  const year = baseYear + Math.floor(absMonth / 12);
  const month = absMonth % 12;
  return `${MONTH_NAMES_SHORT[month]} ${String(year).slice(2)}`;
}

const MONTH_NAMES_ES = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
function keyToLabel(key) {
  const [yr, mn] = key.split('-').map(Number);
  return `${MONTH_NAMES_ES[mn-1]} ${String(yr).slice(2)}`;
}
function labelToKey(lbl) {
  const months = {Ene:1,Feb:2,Mar:3,Abr:4,May:5,Jun:6,Jul:7,Ago:8,Sep:9,Oct:10,Nov:11,Dic:12};
  const m = lbl.trim().match(/^([A-Za-z]+)\s*(\d{2,4})$/);
  if (!m) return null;
  const mon = months[m[1].charAt(0).toUpperCase()+m[1].slice(1).toLowerCase()];
  if (!mon) return null;
  const yr = m[2].length===2 ? 2000+parseInt(m[2]) : parseInt(m[2]);
  return `${yr}-${String(mon).padStart(2,'0')}`;
}
function shiftKey(key, delta) {
  const [yr, mn] = key.split('-').map(Number);
  const d = new Date(yr, mn-1+delta, 1);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
}
function sortedHormigaKeys() { return Object.keys(hormigaData).sort(); }

let activeHormigaMonth = keyToLabel(activeHormigaKey); 
let healthCompareChart, allExpensesChart, catChart, distChart, debtChart, projChart, healthRingChart, hormigaCatChart, timelineMonthlyChart, hormigaCompareChart;

function fmt(n) { return '$' + Number(n).toLocaleString('es-MX', {minimumFractionDigits:2, maximumFractionDigits:2}); }
function totalMonthlyServices() { return services.reduce((a,s) => a + monthlyAmount(s), 0); }
function debtMonthlyPayment(d) {
  if (d.mode === 'manual' && d.monthlyAmounts.length > 0) return d.monthlyAmounts[0] || 0;
  if (d.mode === 'auto' && (d.autoSub||'months') === 'monthly') return d.fixedMonthly || 0;
  return d.months > 0 ? d.total / d.months : 0;
}
function totalMonthlyDebt() { return debts.reduce((a,d) => a + debtMonthlyPayment(d), 0); }
function totalDebt() { return debts.reduce((a,d) => a + Number(d.total), 0); }
function totalHormigaMonth(key) { return (hormigaData[key] || []).reduce((a,e) => a + Number(e.amount||0), 0); }
function totalHormigaCurrent() { return totalHormigaMonth(activeHormigaKey); }
function totalIncome() { return incomes.reduce((sum, inc) => sum + (Number(inc.amount)||0), 0); }
function catTotals() {
  const map = {};
  services.forEach(s => { const m = monthlyAmount(s); const label = catLabel(s.cat); map[label] = (map[label]||0) + m; });
  return map;
}
function catColorByLabel(label) { const c = userCats.find(x=>x.label===label); return c ? c.color : '#888'; }
function destroyChart(c) { if (c) { try { c.destroy(); } catch(e){} } }

// Fuentes predefinidas para el panel de ingresos
let incomeSources = ['üíº Sueldo','üßë‚Äçüíª Freelance','üè† Renta','üìà Inversi√≥n','üéÅ Otro'];

function goToTab(tab, btnId) {
  // Quitar activo de todos los sec-btn
  document.querySelectorAll('.sec-btn').forEach(b => b.classList.remove('active'));
  // Ocultar todos los tabs
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  // Activar tab
  const tabEl = document.getElementById('tab-' + tab);
  if (tabEl) tabEl.classList.add('active');
  // Activar bot√≥n sec-btn si existe
  const btnEl = document.getElementById(btnId);
  if (btnEl) btnEl.classList.add('active');
  // Scroll al contenido
  setTimeout(() => {
    if (tabEl) tabEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
    if (tab === 'gastos') { renderCatChart(); renderCatManager(); }
    if (tab === 'graficas') { renderDistChart(); renderDebtChart(); renderProjChart(); renderAllExpensesChart(); renderPayTimeline(); }
    if (tab === 'salud') { renderHealthRing(); renderHealthCompareChart(); }
    if (tab === 'timeline') renderTimeline();
    if (tab === 'hormiga') { renderHormigaCharts(); renderHormigaCatBadges(); renderHormigaMonths(); renderHormigaEntries(); }
    if (tab === 'ingresos') renderIncomesQuick();
    if (tab === 'deudas') { renderDebts(); renderTdcCalendar(); }
  }, 50);
}

// Mantener switchTab como alias para compatibilidad interna
function switchTab(tab, btn) {
  goToTab(tab, btn ? btn.id : null);
}

function renderIncomes() {
  // Actualizar el display del total en el salary-row del header
  const disp = document.getElementById('total-income-display');
  if (disp) disp.textContent = fmt(totalIncome());
  renderIncomesQuick();
}

function renderIncomesQuick() {
  // Botones de fuentes
  const srcContainer = document.getElementById('income-sources-container');
  if (srcContainer) {
    srcContainer.innerHTML = incomeSources.map(src =>
      `<button class="income-source-btn" onclick="selectIncomeSource('${src}')">${src}</button>`
    ).join('');
  }

  // Lista de entradas
  const listEl = document.getElementById('income-entries-list');
  if (listEl) {
    if (incomes.length === 0) {
      listEl.innerHTML = `<div style="text-align:center;padding:22px 0;color:var(--muted);font-size:0.78rem;">Sin ingresos registrados</div>`;
    } else {
      listEl.innerHTML = incomes.map(i => `
        <div class="income-entry">
          <div>
            <div style="font-size:0.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.05em;" id="income-src-${i.id}">${i.name}</div>
            <div class="income-entry-name">${i.desc || ''}</div>
          </div>
          <div style="display:flex;align-items:center;gap:10px;">
            <span class="income-entry-amount">${fmt(i.amount)}</span>
            <button class="btn btn-danger" style="padding:2px 8px;font-size:0.6rem;" onclick="removeIncome(${i.id})">‚úï</button>
          </div>
        </div>`).join('');
    }
  }

  // Resumen lateral
  const total = totalIncome();
  const committed = totalMonthlyServices() + totalMonthlyDebt() + totalHormigaCurrent();
  const libre = total - committed;
  const sumTotal = document.getElementById('income-summary-total');
  const sumCount = document.getElementById('income-summary-count');
  const sumCommitted = document.getElementById('income-summary-committed');
  const sumFree = document.getElementById('income-summary-free');
  if (sumTotal) sumTotal.textContent = fmt(total);
  if (sumCount) sumCount.textContent = incomes.length;
  if (sumCommitted) sumCommitted.textContent = fmt(committed);
  if (sumFree) { sumFree.textContent = fmt(libre); sumFree.style.color = libre >= 0 ? 'var(--accent4)' : 'var(--danger)'; }

  // Total en header
  const disp = document.getElementById('total-income-display');
  if (disp) disp.textContent = fmt(total);
}

// Fuente seleccionada actualmente
let _selectedIncomeSource = '';
function selectIncomeSource(src) {
  _selectedIncomeSource = src;
  document.querySelectorAll('.income-source-btn').forEach(b =>
    b.classList.toggle('active', b.textContent === src));
  document.getElementById('income-amount').focus();
}

function addIncomeSource() {
  const name = prompt('Nombre de la nueva fuente de ingreso:');
  if (!name || !name.trim()) return;
  incomeSources.push(name.trim());
  renderIncomesQuick();
}

function saveIncomeQuick() {
  const amtEl = document.getElementById('income-amount');
  const amount = parseFloat(amtEl.value) || 0;
  if (amount <= 0) { amtEl.focus(); return; }
  const name = _selectedIncomeSource || 'üíº Sueldo';
  const desc = document.getElementById('income-desc').value.trim();
  incomes.push({ id: nextIncomeId++, name, desc, amount });
  amtEl.value = '';
  document.getElementById('income-desc').value = '';
  _selectedIncomeSource = '';
  document.querySelectorAll('.income-source-btn').forEach(b => b.classList.remove('active'));
  recalculate();
}

function updateIncome(id,k,v) { 
  const i=incomes.find(x=>x.id===id); 
  if(i) { if(k==='amount') i[k]=parseFloat(v)||0; else i[k]=v; }
  recalculate();
}
function addIncome() { incomes.push({id:nextIncomeId++, name:'üíº Sueldo', desc:'', amount:0}); recalculate(); }
function removeIncome(id) { incomes = incomes.filter(x=>x.id!==id); recalculate(); }

function renderCatManager() {
  const el = document.getElementById('cat-manager');
  if (!el) return;
  el.innerHTML = userCats.map(c => `
    <div style="display:flex;align-items:center;gap:6px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:6px 10px;">
      <input type="color" value="${c.color}" title="Color" style="width:22px;height:22px;border:none;background:none;cursor:pointer;padding:0;border-radius:50%;" onchange="updateCat('${c.id}','color',this.value)">
      <input value="${c.label}" placeholder="Nombre..." style="background:transparent;border:none;border-bottom:1px dashed ${c.color}55;color:var(--text);font-family:'DM Mono',monospace;font-size:0.78rem;width:110px;padding:1px 4px;" onchange="updateCat('${c.id}','label',this.value); renameCatInServices('${c.id}',this.value)">
      ${userCats.length>1?`<button class="btn btn-danger" style="padding:2px 8px;font-size:0.65rem;" onclick="removeUserCat('${c.id}')">‚úï</button>`:''}
    </div>`).join('');
}
function addUserCat() {
  const id = 'cat_' + (nextCatId++); const colors = ['#ec4899','#8b5cf6','#06b6d4','#84cc16','#f43f5e','#f59e0b'];
  userCats.push({id, label:'nueva categor√≠a', color: colors[userCats.length % colors.length]});
  renderCatManager(); renderServices(); renderCatChart(); saveData();
}
function removeUserCat(id) {
  services.forEach(s => { if(s.cat===id) s.cat='otro'; });
  userCats = userCats.filter(c=>c.id!==id);
  renderCatManager(); recalculate();
}
function updateCat(id, key, val) {
  const c = userCats.find(x=>x.id===id); if (!c) return;
  c[key] = val; 
  renderCatManager(); renderServices(); renderCatChart(); saveData();
}
function renameCatInServices(id, newLabel) { renderServices(); renderCatChart(); }

function monthlyAmount(s) {
  const a = s.amount || 0;
  switch(s.freq) {
    case 'diaria':      return a * 30.44;
    case 'semanal':     return a * 4.33;
    case 'quincenal':   return a * 2;
    case 'mensual':     return a;
    case 'bimestral':   return a / 2;
    case 'trimestral':  return a / 3;
    case 'semestral':   return a / 6;
    case 'anual':       return a / 12;
    case 'custom':      return s.customDays > 0 ? a / (s.customDays / 30.44) : a;
    default:            return a;
  }
}

const FREQ_LABELS = { diaria:'Diaria', semanal:'Semanal', quincenal:'Quincenal', mensual:'Mensual', bimestral:'Bimestral', trimestral:'Trimestral', semestral:'Semestral', anual:'Anual', custom:'Personalizada' };

function renderServices() {
  const tbody = document.getElementById('services-body');
  if(!tbody) return;
  tbody.innerHTML = '';
  services.forEach(s => {
    const catOpts = userCats.map(c => `<option value="${c.id}" ${s.cat===c.id?'selected':''}>${c.label}</option>`).join('');
    const freqOpts = Object.entries(FREQ_LABELS).map(([v,l]) => `<option value="${v}" ${s.freq===v?'selected':''}>${l}</option>`).join('');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="name-input" style="width:100%; min-width:180px;" value="${s.name}" onchange="updateService(${s.id},'name',this.value)"></td>
      <td>
        <div style="display:flex;align-items:center;gap:4px;">
          <span style="width:8px;height:8px;border-radius:50%;background:${catColor(s.cat)};flex-shrink:0;display:inline-block;"></span>
          <select class="cat-select" style="max-width:120px;" onchange="updateService(${s.id},'cat',this.value)">${catOpts}</select>
        </div>
      </td>
      <td>
        <select class="freq-select" onchange="updateService(${s.id},'freq',this.value)">${freqOpts}</select>
        ${s.freq==='custom' ? `<div style="margin-top:4px;display:flex;align-items:center;gap:4px;"><input type="number" inputmode="numeric" value="${s.customDays||30}" min="1" style="width:50px;background:var(--surface2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.72rem;padding:3px 6px;" onchange="updateService(${s.id},'customDays',this.value)"><span style="font-size:0.65rem;color:var(--muted)">d√≠as</span></div>` : ''}
      </td>
      <td style="text-align:right">
        <input class="editable-input" type="number" value="${s.amount}" onchange="updateService(${s.id},'amount',this.value)" inputmode="decimal">
        <div style="font-size:0.62rem;color:var(--muted);text-align:right;margin-top:2px;">${fmt(monthlyAmount(s))}/mes</div>
      </td>
      <td><button class="btn btn-danger" onclick="removeService(${s.id})">‚úï</button></td>
    `;
    tbody.appendChild(tr);
  });
  renderCatManager();
}

function updateService(id, key, val) {
  const s = services.find(x => x.id===id); if (!s) return;
  if (key==='amount' || key==='customDays') s[key] = parseFloat(val)||0; else s[key] = val;
  recalculate();
}
function addService() { services.push({id:nextServiceId++, name:'Nuevo servicio', amount:0, freq:'mensual', cat:'otro', customDays:30}); recalculate(); }
function removeService(id) { services = services.filter(x => x.id!==id); recalculate(); }

function debtScheduleFromMonthly(d) {
  const total = d.total || 0;
  const mp = d.fixedMonthly || 0;
  if (!mp) return { months: 0, schedule: [] };
  const fullMonths = Math.floor(total / mp);
  const residue = total - fullMonths * mp;
  const schedule = [];
  for (let i = 0; i < fullMonths; i++) schedule.push(mp);
  if (residue > 0.01) schedule.push(residue);
  return { months: schedule.length, schedule };
}

function renderDebts() {
  const cont = document.getElementById('debts-container');
  if(!cont) return;
  cont.innerHTML = '';
  debts.forEach(d => {
    if (!d.payments) d.payments = {};
    let effectiveMonths, effectiveMonthly;
    if (d.mode === 'auto') {
      if (d.autoSub === 'monthly') {
        const sch = debtScheduleFromMonthly(d);
        effectiveMonths = sch.months; effectiveMonthly = d.fixedMonthly || 0;
      } else {
        effectiveMonths = d.months; effectiveMonthly = d.months > 0 ? d.total / d.months : 0;
      }
    } else {
      effectiveMonths = d.monthlyAmounts.length; effectiveMonthly = d.monthlyAmounts[0] || 0;
    }

    const autoSub = d.autoSub || 'months';
    const autoMonthly = d.months > 0 ? (d.total / d.months) : 0;
    const sch = debtScheduleFromMonthly(d);
    let scheduleInfo = '';
    if (autoSub === 'monthly' && sch.months > 0) {
      const fullPays = sch.schedule.filter(v => Math.abs(v - (d.fixedMonthly||0)) < 0.01).length;
      const residue = sch.schedule[sch.schedule.length - 1];
      const hasResidue = Math.abs(residue - (d.fixedMonthly||0)) > 0.01;
      scheduleInfo = `<div class="calc-badge" style="margin-top:8px;flex-wrap:wrap;gap:6px;">
        <span>üìÖ Meses para liquidar: <strong>${sch.months}</strong></span>
        &nbsp;|&nbsp;
        <span>${fullPays} ${fullPays===1?'pago':'pagos'} de <strong>${fmt(d.fixedMonthly||0)}</strong></span>
        ${hasResidue ? `&nbsp;|&nbsp;<span>√öltimo pago: <strong style="color:var(--accent3)">${fmt(residue)}</strong></span>` : ''}
      </div>`;
    }

    const autoFieldsHTML = `
      <div class="debt-fields" id="debt-auto-fields-${d.id}">
        <div class="debt-field" style="grid-column:1/-1">
          <div style="display:flex;gap:4px;margin-bottom:10px;">
            <div class="mode-btn ${autoSub==='months'?'active':''}" style="font-size:0.65rem;" onclick="toggleDebtAutoSub(${d.id},'months')">üìÖ Ingresar meses ‚Üí calcular cuota</div>
            <div class="mode-btn ${autoSub==='monthly'?'active':''}" style="font-size:0.65rem;" onclick="toggleDebtAutoSub(${d.id},'monthly')">üíµ Ingresar cuota ‚Üí calcular meses</div>
          </div>
        </div>
        <div class="debt-field">
          <label>Deuda total (MXN)</label>
          <input type="number" inputmode="decimal" value="${d.total||''}" placeholder="0.00" onchange="updateDebtField(${d.id},'total',this.value)">
        </div>
        ${autoSub==='months' ? `
        <div class="debt-field"><label>Meses para liquidar</label><input type="number" inputmode="numeric" value="${d.months||''}" min="1" placeholder="ej: 12" onchange="updateDebtField(${d.id},'months',this.value)"></div>
        <div class="debt-field"><label>Mensualidad calculada</label><input type="text" value="${fmt(autoMonthly)}" readonly style="color:var(--accent);background:rgba(0,229,255,0.06)"></div>
        ` : `
        <div class="debt-field"><label>Monto mensual fijo (MXN)</label><input type="number" inputmode="decimal" value="${d.fixedMonthly||''}" placeholder="ej: 2000" onchange="updateDebtField(${d.id},'fixedMonthly',this.value)"></div>
        <div class="debt-field"><label>Meses calculados</label><input type="text" value="${sch.months || '‚Äî'}" readonly style="color:var(--accent);background:rgba(0,229,255,0.06)"></div>
        ${scheduleInfo}
        `}
        <div class="debt-field" style="grid-column:1/-1"><label>Notas</label><textarea placeholder="Observaciones, recordatorios..." onchange="updateDebtField(${d.id},'note',this.value)">${d.note||''}</textarea></div>
      </div>`;

    if (d.monthlyAmounts.length === 0) d.monthlyAmounts.push(0);
    const numSlots = d.monthlyAmounts.length;
    const firstLabel = getMonthLabel(0);
    const lastLabel = getMonthLabel(numSlots - 1);
    const manualTotal = d.monthlyAmounts.reduce((a,v)=>a+(Number(v)||0),0);
    const manualGrid = `<div style="margin-top:10px" id="manual-grid-${d.id}">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <span style="font-size:0.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;">${firstLabel} ‚Üí ${lastLabel} ¬∑ <strong style="color:var(--text)">${numSlots}</strong> meses</span>
        <div style="display:flex;gap:6px;">
          <button class="btn" style="padding:3px 10px;font-size:0.65rem;border-color:var(--accent2);color:var(--accent2);" onclick="removeManualMonth(${d.id})">‚àí Quitar mes</button>
          <button class="btn" style="padding:3px 10px;font-size:0.65rem;border-color:var(--accent);color:var(--accent);" onclick="addManualMonth(${d.id})">+ Agregar mes</button>
        </div>
      </div>
      <div class="monthly-grid" style="grid-template-columns:repeat(auto-fill,minmax(80px,1fr));">
        ${d.monthlyAmounts.map((v,i) => `
          <div class="monthly-cell"><label>${getMonthLabel(i)}</label><input type="number" inputmode="decimal" value="${v||''}" placeholder="0" onchange="updateDebtMonthly(${d.id},${i},this.value)"></div>
        `).join('')}
      </div>
      <div class="calc-badge" id="manual-badge-${d.id}" style="margin-top:8px;">
        ‚àë Total programado: <strong>${fmt(manualTotal)}</strong> &nbsp;|&nbsp; Pago mes 1: <strong>${fmt(d.monthlyAmounts[0]||0)}</strong>
        ${d.total > 0 ? `&nbsp;|&nbsp; <span style="color:${manualTotal>=d.total?'var(--success)':'var(--accent2)'}">${manualTotal>=d.total?'‚úì Cubre deuda':'Falta: '+fmt(d.total-manualTotal)}</span>` : ''}
      </div>
    </div>`;

    const manualFieldsHTML = `
      <div id="debt-manual-fields-${d.id}">
        <div class="debt-fields">
          <div class="debt-field"><label>Deuda total (MXN)</label><input type="number" inputmode="decimal" value="${d.total||''}" placeholder="0.00" onchange="updateDebtField(${d.id},'total',this.value)"></div>
          <div class="debt-field" style="grid-column:2/-1"><label>Notas</label><textarea placeholder="Observaciones, recordatorios..." onchange="updateDebtField(${d.id},'note',this.value)">${d.note||''}</textarea></div>
        </div>
        ${manualGrid}
      </div>`;

    // Determine months this debt is active
    const isMonthlyMode = d.mode === 'auto' && (d.autoSub||'months') === 'monthly';
    const schForPay = isMonthlyMode ? debtScheduleFromMonthly(d) : null;
    const totalActiveMonths = d.mode === 'manual'
      ? d.monthlyAmounts.filter(v=>v>0).length
      : isMonthlyMode ? (schForPay ? schForPay.months : 0) : (d.months || 0);

    // Build payment calendar cells (up to 18 months)
    const visibleMonths = Math.min(Math.max(totalActiveMonths, 1), 18);
    const nowKey = (() => { const n = new Date(); return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}`; })();
    let payCalendarHTML = '';
    const paidCount = Object.values(d.payments||{}).filter(Boolean).length;
    
    if (totalActiveMonths > 0) {
      const cells = [];
      for (let i = 0; i < visibleMonths; i++) {
        const mKey = getDebtMonthKey(i);
        const mLabel = getMonthLabel(i);
        let pay = 0;
        if (d.mode === 'manual') pay = d.monthlyAmounts[i] || 0;
        else if (isMonthlyMode) pay = schForPay ? (schForPay.schedule[i] || 0) : 0;
        else pay = i < d.months ? d.total / d.months : 0;

        const isActive = pay > 0;
        const isPaid = !!(d.payments && d.payments[mKey]);
        const isCurrent = mKey === nowKey;

        let cls = 'dpc-btn inactive';
        let icon = '‚Äî';
        if (isActive) {
          cls = isPaid ? 'dpc-btn paid' : 'dpc-btn pending';
          icon = isPaid ? '‚úì' : (isCurrent ? '‚è≥' : fmt(pay).replace('$',''));
        }
        const onclick = isActive ? `onclick="toggleDebtPayment(${d.id},'${mKey}')"` : '';
        const currentStyle = isCurrent && isActive ? `box-shadow:0 0 0 2px ${d.color};` : '';
        cells.push(`<div class="dpc-cell"><div class="dpc-label">${mLabel}</div><div class="${cls}" style="${currentStyle}" ${onclick} title="${isActive?(isPaid?'‚úì Pagado ‚Äî clic para desmarcar':'Clic para marcar como pagado'):'Sin pago este mes'}">${icon}</div></div>`);
      }
      payCalendarHTML = `
        <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border);">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
            <div style="font-size:0.65rem;text-transform:uppercase;letter-spacing:0.08em;color:var(--muted);">Control de pagos</div>
            <div style="display:flex;gap:10px;font-size:0.65rem;">
              <span style="color:var(--success);">‚úì ${paidCount} pagado${paidCount!==1?'s':''}</span>
              <span style="color:var(--accent2);">‚è≥ ${totalActiveMonths - paidCount} pendiente${(totalActiveMonths-paidCount)!==1?'s':''}</span>
            </div>
          </div>
          <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:4px;">
            <div class="debt-pay-calendar" style="flex-wrap:nowrap;min-width:max-content;">${cells.join('')}</div>
          </div>
          <div style="font-size:0.62rem;color:var(--muted);margin-top:8px;">Toca un mes para marcar/desmarcar el pago como realizado.</div>
        </div>`;
    }

    // Cut & pay day fields
    const MONTHS_ES_SHORT = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
    const nowDate = new Date();
    const cutDayHint = d.cutDay > 0 ? `Pr√≥ximo corte: ${d.cutDay} ${MONTHS_ES_SHORT[nowDate.getMonth()]}` : 'Sin configurar';
    const payDayHint = d.payDay > 0 ? `Pr√≥ximo pago: ${d.payDay} ${MONTHS_ES_SHORT[nowDate.getMonth()]}` : 'Sin configurar';
    const datesHTML = `
      <div class="debt-dates-row">
        <div class="debt-date-field" style="border-top:3px solid ${d.color}88;">
          <label>üìÖ D√≠a de corte</label>
          <input type="number" inputmode="numeric" min="1" max="31" value="${d.cutDay||''}" placeholder="ej. 15" onchange="updateDebtField(${d.id},'cutDay',this.value)">
          <div class="day-hint">${cutDayHint}</div>
        </div>
        <div class="debt-date-field" style="border-top:3px solid ${d.color}88;">
          <label>üí≥ D√≠a l√≠mite de pago</label>
          <input type="number" inputmode="numeric" min="1" max="31" value="${d.payDay||''}" placeholder="ej. 25" onchange="updateDebtField(${d.id},'payDay',this.value)">
          <div class="day-hint">${payDayHint}</div>
        </div>
      </div>`;

    // Progress
    const paid_pct = Math.min(100, totalActiveMonths > 0 ? (paidCount / totalActiveMonths * 100) : 0).toFixed(0);

    const div = document.createElement('div');
    div.className = 'debt-item';
    div.innerHTML = `
      <div class="debt-header">
        <div style="display:flex;align-items:center;gap:10px;flex:1 1 180px;">
          <input type="color" value="${d.color}" title="Color de tarjeta" style="width:30px;height:30px;border:none;background:none;cursor:pointer;border-radius:50%;padding:0;flex-shrink:0;" onchange="updateDebtField(${d.id},'color',this.value)">
          <input class="debt-name-input" value="${d.name}" spellcheck="false" style="font-family:'DM Serif Display',serif;font-size:1.1rem;background:transparent;border:none;border-bottom:1px dashed ${d.color}44;color:${d.color};width:100%;max-width:180px;padding:2px 4px;" onchange="updateDebtField(${d.id},'name',this.value)" onfocus="this.style.borderBottomColor='${d.color}'" onblur="this.style.borderBottomColor='${d.color}44'">
        </div>
        <div style="display:flex;align-items:center;gap:8px; flex-wrap:wrap;">
          <span class="debt-total-badge">Total: ${fmt(d.total)}</span>
          <button class="btn btn-danger" onclick="removeDebt(${d.id})">‚úï</button>
        </div>
      </div>
      ${datesHTML}
      <div class="mode-toggle" style="margin-top:14px;">
        <div class="mode-btn ${d.mode==='auto'?'active':''}" onclick="toggleDebtMode(${d.id},'auto')">‚ö° Auto</div>
        <div class="mode-btn ${d.mode==='manual'?'active':''}" onclick="toggleDebtMode(${d.id},'manual')">‚úèÔ∏è Manual (mes a mes)</div>
      </div>
      ${d.mode==='auto' ? autoFieldsHTML : manualFieldsHTML}
      ${payCalendarHTML}
      <div style="display:flex;align-items:center;gap:10px;font-size:0.72rem;color:var(--muted);margin-top:14px">
        <span>Pagos realizados</span>
        <div class="progress-bar-wrap" style="flex:1"><div class="progress-bar" style="width:${paid_pct}%;background:${paidCount>0?'var(--success)':d.color}"></div></div>
        <span style="color:${paidCount>0?'var(--success)':d.color}">${paid_pct}%</span>
      </div>
    `;
    cont.appendChild(div);
  });
}

function toggleDebtMode(id, mode) {
  const d = debts.find(x => x.id===id); if (!d) return;
  d.mode = mode;
  if (mode==='manual' && d.monthlyAmounts.length===0) {
    const mp = d.months > 0 ? d.total/d.months : 0;
    d.monthlyAmounts = Array(Math.min(d.months||12,12)).fill(parseFloat(mp.toFixed(2)));
  }
  recalculate();
}

function renderTdcCalendar() {
  const el = document.getElementById('tdc-dates-calendar'); if (!el) return;
  const now = new Date();
  const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
  const MONTHS_ES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const monthName = MONTHS_ES[now.getMonth()];

  // Build horizontal timeline: 31 days
  const days = Array.from({length: daysInMonth}, (_,i) => i+1);
  const events = []; // {day, type:'corte'|'pago', debt}
  debts.forEach(d => {
    if (d.cutDay > 0 && d.cutDay <= daysInMonth) events.push({day: d.cutDay, type: 'corte', debt: d});
    if (d.payDay > 0 && d.payDay <= daysInMonth) events.push({day: d.payDay, type: 'pago', debt: d});
  });

  if (debts.every(d => !d.cutDay && !d.payDay)) {
    el.innerHTML = `<div style="text-align:center;padding:24px;color:var(--muted);font-size:0.82rem;">Configura los d√≠as de corte y pago en cada tarjeta para ver el calendario aqu√≠.</div>`;
    return;
  }

  // Timeline bar
  const today = now.getDate();
  let barHtml = `<div style="position:relative;min-width:${daysInMonth*34}px;height:80px;margin-bottom:8px;">`;
  // Day ticks
  days.forEach(d => {
    const isToday = d === today;
    barHtml += `<div style="position:absolute;left:${(d-1)*34}px;top:0;width:32px;text-align:center;">
      <div style="font-size:0.55rem;color:${isToday?'var(--accent)':'var(--muted)'};margin-bottom:2px;font-weight:${isToday?'600':'400'}">${d}</div>
      <div style="width:1px;height:6px;background:${isToday?'var(--accent)':'var(--border)'};margin:0 auto;"></div>
    </div>`;
  });
  // Horizontal base line
  barHtml += `<div style="position:absolute;left:0;right:0;top:18px;height:2px;background:var(--border);border-radius:1px;"></div>`;
  // Today marker
  barHtml += `<div style="position:absolute;left:${(today-1)*34+15}px;top:14px;width:4px;height:10px;background:var(--accent);border-radius:2px;"></div>`;
  // Events
  events.forEach(ev => {
    const leftPx = (ev.day-1)*34 + 4;
    const isCorte = ev.type === 'corte';
    const color = ev.debt.color;
    const icon = isCorte ? '‚úÇ' : 'üí≥';
    const label = isCorte ? 'Corte' : 'Pago';
    barHtml += `<div title="${ev.debt.name} ‚Äî ${label} d√≠a ${ev.day}" style="position:absolute;left:${leftPx}px;top:24px;display:flex;flex-direction:column;align-items:center;gap:2px;cursor:default;">
      <div style="width:24px;height:24px;border-radius:50%;background:${color}22;border:2px solid ${color};display:flex;align-items:center;justify-content:center;font-size:0.75rem;">${icon}</div>
      <div style="font-size:0.5rem;color:${color};white-space:nowrap;max-width:40px;overflow:hidden;text-overflow:ellipsis;text-align:center;">${ev.debt.name}</div>
    </div>`;
  });
  barHtml += `</div>`;

  // Legend row
  const legendItems = debts.filter(d => d.cutDay || d.payDay).map(d => {
    const parts = [];
    if (d.cutDay) parts.push(`‚úÇ d√≠a ${d.cutDay}`);
    if (d.payDay) parts.push(`üí≥ d√≠a ${d.payDay}`);
    return `<div style="display:flex;align-items:center;gap:6px;background:var(--surface2);border:1px solid ${d.color}44;border-left:3px solid ${d.color};border-radius:6px;padding:6px 10px;white-space:nowrap;">
      <span style="color:${d.color};font-family:'DM Serif Display',serif;font-size:0.88rem;">${d.name}</span>
      <span style="font-size:0.65rem;color:var(--muted);">${parts.join(' ¬∑ ')}</span>
    </div>`;
  }).join('');

  el.innerHTML = `
    <div style="font-size:0.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:12px;">${monthName} ${now.getFullYear()}</div>
    <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:8px;">${barHtml}</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">${legendItems}</div>
  `;
}
function toggleDebtAutoSub(id, sub) { const d = debts.find(x => x.id===id); if (d) { d.autoSub = sub; recalculate(); } }

function updateDebtField(id, key, val) {
  const d = debts.find(x => x.id===id); if (!d) return;
  if (['total','months','fixedMonthly','cutDay','payDay'].includes(key)) d[key] = parseFloat(val)||0; else d[key] = val;
  recalculate();
}

function toggleDebtPayment(id, monthKey) {
  const d = debts.find(x => x.id === id); if (!d) return;
  if (!d.payments) d.payments = {};
  if (d.payments[monthKey]) {
    delete d.payments[monthKey];
  } else {
    d.payments[monthKey] = true;
  }
  recalculate();
}

function getDebtMonthKey(monthIndex) {
  // monthIndex 0 = Mar 2026
  const base = new Date(2026, 2, 1);
  base.setMonth(base.getMonth() + monthIndex);
  return `${base.getFullYear()}-${String(base.getMonth()+1).padStart(2,'0')}`;
}
function updateDebtMonthly(id, idx, val) {
  const d = debts.find(x => x.id===id); if (!d) return;
  d.monthlyAmounts[idx] = parseFloat(val)||0;
  recalculate();
}

function addManualMonth(id) { const d = debts.find(x => x.id===id); if (d) { d.monthlyAmounts.push(0); recalculate(); } }
function removeManualMonth(id) { const d = debts.find(x => x.id===id); if (d && d.monthlyAmounts.length > 1) { d.monthlyAmounts.pop(); recalculate(); } }
function addDebt() {
  const colors = ['#22d3ee','#c084fc','#fb923c','#4ade80','#f472b6','#a3e635'];
  debts.push({id:nextDebtId++, name:'Nueva tarjeta', total:0, months:3, mode:'auto', autoSub:'months', fixedMonthly:0, color:colors[debts.length%colors.length], note:'', monthlyAmounts:[], cutDay:0, payDay:0, payments:{}});
  recalculate();
}
function removeDebt(id) { debts = debts.filter(x => x.id!==id); recalculate(); }

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  GASTOS HORMIGA Y CALENDARIO
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHormigaMonths() {
  const el = document.getElementById('hormiga-months'); if (!el) return;
  const allKeys = sortedHormigaKeys();
  const activeIdx = allKeys.indexOf(activeHormigaKey);
  const start = Math.max(0, activeIdx - 2); const end = Math.min(allKeys.length - 1, start + 5);
  const shown = allKeys.slice(start, end+1);
  el.innerHTML = shown.map(k => `<span class="month-tab ${k===activeHormigaKey?'active':''}" onclick="setHormigaMonth('${k}')">${keyToLabel(k)}</span>`).join('');
  const jumpEl = document.getElementById('hormiga-jump-month'); if (jumpEl) jumpEl.value = activeHormigaKey;
}
function ensureHormigaKey(key) { if (!hormigaData[key]) hormigaData[key] = []; }
function setHormigaMonth(key) {
  ensureHormigaKey(key); activeHormigaKey = key; activeHormigaMonth = keyToLabel(key);
  // Reset date input to appropriate default
  const dateEl = document.getElementById('hormiga-date-input');
  if (dateEl) {
    const today = new Date();
    const todayYrMn = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
    dateEl.value = todayYrMn === key ? `${key}-${String(today.getDate()).padStart(2,'0')}` : '';
    dateEl.min = `${key}-01`;
    const [yr, mn] = key.split('-').map(Number);
    dateEl.max = `${key}-${String(new Date(yr, mn, 0).getDate()).padStart(2,'0')}`;
  }
  renderHormigaMonths(); renderHormigaEntries(); renderHormigaCharts(); updateKPIs(); saveData();
}
function shiftHormigaMonth(delta) { const newKey = shiftKey(activeHormigaKey, delta); ensureHormigaKey(newKey); setHormigaMonth(newKey); }
function jumpToHormigaMonth(val) { if (!val) return; ensureHormigaKey(val); setHormigaMonth(val); }
function setHormigaMonthManual(val) { const key = labelToKey(val); if (!key) return; ensureHormigaKey(key); setHormigaMonth(key); }

// Categor√≠a seleccionada actualmente para captura r√°pida
let _selectedHormigaCat = '';
function selectHormigaCat(cat) {
  _selectedHormigaCat = cat;
  document.querySelectorAll('#hormiga-cats-bar .income-source-btn').forEach(b => {
    const label = b.childNodes[0] ? b.childNodes[0].textContent.trim() : b.textContent.trim();
    b.classList.toggle('active', label.startsWith(cat.slice(0,4)));
  });
  document.getElementById('hormiga-amount').focus();
}

function saveHormigaQuick() {
  const amtEl = document.getElementById('hormiga-amount');
  const amount = parseFloat(amtEl.value) || 0;
  if (amount <= 0) { amtEl.focus(); return; }
  const desc = document.getElementById('hormiga-desc-input').value.trim();
  const dateEl = document.getElementById('hormiga-date-input');
  const cat = _selectedHormigaCat || (hormigaCatBadges.length > 0 ? hormigaCatBadges[0] : 'Otro');
  // Determine date
  const today = new Date();
  const todayYrMn = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
  let defDate = `${activeHormigaKey}-01`;
  if (todayYrMn === activeHormigaKey) defDate = `${activeHormigaKey}-${String(today.getDate()).padStart(2,'0')}`;
  const date = dateEl.value || defDate;
  if (!hormigaData[activeHormigaKey]) hormigaData[activeHormigaKey] = [];
  hormigaData[activeHormigaKey].push({id: nextHormigaId++, desc, cat, amount, date});
  // Reset form
  amtEl.value = '';
  document.getElementById('hormiga-desc-input').value = '';
  dateEl.value = '';
  recalculate();
}

function renderHormigaCatBadges() {
  const el = document.getElementById('hormiga-cats-bar'); if (!el) return;
  el.innerHTML = hormigaCatBadges.map((cat,i) => `
    <button class="income-source-btn" style="border-color:var(--hormiga);" onclick="selectHormigaCat('${cat.replace(/'/g,"\\'")}','${cat.replace(/'/g,"\\'")}')" id="hormiga-cat-btn-${i}" title="${cat}">
      ${cat}
      <span style="font-size:0.55rem;opacity:0.6;margin-left:3px;cursor:pointer;" onclick="event.stopPropagation();renameHormigaCat(${i})" title="Renombrar">‚úèÔ∏è</span>
      ${hormigaCatBadges.length>1?`<span style="font-size:0.55rem;opacity:0.6;cursor:pointer;" onclick="event.stopPropagation();removeHormigaCat(${i})" title="Eliminar">‚úï</span>`:''}
    </button>`).join('');
  // Re-highlight active
  if (_selectedHormigaCat) {
    document.querySelectorAll('#hormiga-cats-bar .income-source-btn').forEach(b => {
      b.classList.toggle('active', b.textContent.trim().startsWith(_selectedHormigaCat.trim().slice(0,4)));
    });
  }
}
function addHormigaCatBadge() { 
  const name = prompt('Nombre de la nueva categor√≠a:'); 
  if (!name || !name.trim()) return; 
  hormigaCatBadges.push(name.trim()); 
  renderHormigaCatBadges(); 
  renderHormigaEntries(); 
  saveData();
}
function renameHormigaCat(i) {
  const newName = prompt('Nuevo nombre:', hormigaCatBadges[i]); if (!newName || !newName.trim()) return;
  const old = hormigaCatBadges[i]; hormigaCatBadges[i] = newName.trim();
  Object.values(hormigaData).forEach(arr => arr.forEach(e => { if(e.cat===old) e.cat=newName.trim(); }));
  renderHormigaCatBadges(); renderHormigaEntries(); renderHormigaCharts(); saveData();
}
function removeHormigaCat(i) {
  hormigaCatBadges.splice(i, 1);
  renderHormigaCatBadges(); renderHormigaEntries(); saveData();
}

function renderHormigaEntries() {
  const entries = hormigaData[activeHormigaKey] || [];
  const listEl = document.getElementById('hormiga-entries-list');
  const totalEl = document.getElementById('hormiga-total-display');

  // Update total display
  const total = totalHormigaMonth(activeHormigaKey);
  if (totalEl) totalEl.textContent = fmt(total);

  if (!listEl) return;
  if (entries.length === 0) {
    listEl.innerHTML = `<div style="text-align:center;padding:22px 0;color:var(--muted);font-size:0.78rem;">Sin gastos registrados en ${keyToLabel(activeHormigaKey)}</div>`;
    return;
  }

  // Sort by date descending
  const sorted = [...entries].sort((a,b) => (b.date||'') > (a.date||'') ? 1 : -1);
  const [yr, mn] = activeHormigaKey.split('-').map(Number);
  const daysInMonth = new Date(yr, mn, 0).getDate();
  const minDate = `${activeHormigaKey}-01`;
  const maxDate = `${activeHormigaKey}-${String(daysInMonth).padStart(2,'0')}`;

  listEl.innerHTML = sorted.map(e => `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(30,45,69,0.35);gap:10px;flex-wrap:wrap;">
      <div style="flex:1;min-width:0;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:3px;flex-wrap:wrap;">
          <span style="font-size:0.62rem;color:var(--hormiga);background:rgba(245,158,11,0.12);border:1px solid rgba(245,158,11,0.3);border-radius:12px;padding:1px 8px;">${e.cat||'Otro'}</span>
          <input type="date" value="${e.date||minDate}" min="${minDate}" max="${maxDate}"
            style="background:transparent;border:none;color:var(--muted);font-family:'DM Mono',monospace;font-size:0.65rem;padding:0;cursor:pointer;"
            onchange="updateHormiga(${e.id},'date',this.value)">
        </div>
        <input class="name-input" style="width:100%;background:transparent;border:none;border-bottom:1px dashed transparent;color:var(--text);font-size:0.82rem;padding:0;"
          value="${e.desc||''}" placeholder="Sin descripci√≥n"
          onfocus="this.style.borderBottomColor='var(--hormiga)'" onblur="this.style.borderBottomColor='transparent'"
          onchange="updateHormiga(${e.id},'desc',this.value)">
      </div>
      <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;">
        <input class="editable-input" type="number" inputmode="decimal" value="${e.amount||''}" placeholder="0.00"
          style="width:80px;text-align:right;"
          onchange="updateHormiga(${e.id},'amount',this.value)">
        <button class="btn btn-danger" style="padding:2px 8px;font-size:0.6rem;" onclick="removeHormiga(${e.id})">‚úï</button>
      </div>
    </div>`).join('');
}

function addHormigaEntry() { saveHormigaQuick(); }

function updateHormiga(id, key, val) {
  const e = (hormigaData[activeHormigaKey]||[]).find(x => x.id===id); if (!e) return;
  if (key==='amount') e.amount = parseFloat(val)||0; else e[key] = val;
  recalculate();
}
function removeHormiga(id) { hormigaData[activeHormigaKey] = (hormigaData[activeHormigaKey]||[]).filter(x=>x.id!==id); recalculate(); }

// EL NUEVO CALENDARIO HEATMAP Y GR√ÅFICOS RESTANTES
function renderHormigaCharts() {
  const allKeys = sortedHormigaKeys();
  
  // 1. DIBUJAR CALENDARIO HEATMAP
  const calContainer = document.getElementById('hormiga-calendar-container');
  if (calContainer) {
      document.getElementById('hormiga-cal-title').textContent = keyToLabel(activeHormigaKey);
      const [yr, mn] = activeHormigaKey.split('-').map(Number);
      const daysInMonth = new Date(yr, mn, 0).getDate();
      const firstDay = new Date(yr, mn - 1, 1).getDay();
      const emptyCells = firstDay === 0 ? 6 : firstDay - 1; // Lunes como d√≠a 1 de la semana

      const dailyTotals = {};
      let maxDaily = 0;
      (hormigaData[activeHormigaKey]||[]).forEach(e => {
        if(e.amount > 0) {
          let day = 1;
          if(e.date && e.date.startsWith(activeHormigaKey)) {
             day = parseInt(e.date.split('-')[2], 10);
          }
          dailyTotals[day] = (dailyTotals[day] || 0) + e.amount;
          if(dailyTotals[day] > maxDaily) maxDaily = dailyTotals[day];
        }
      });

      let html = '<div style="display:grid;grid-template-columns:repeat(7, 1fr);gap:6px;">';
      const dayNames = ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'];
      dayNames.forEach(d => html += `<div style="font-size:0.65rem;color:var(--muted);text-align:center;margin-bottom:4px;text-transform:uppercase;">${d}</div>`);

      for(let i=0; i<emptyCells; i++) html += `<div></div>`;

      let maxDayNumber = 1;

      for(let d=1; d<=daysInMonth; d++) {
         const amt = dailyTotals[d] || 0;
         let cls = 'empty';
         if(amt > 0) {
            const intensity = maxDaily > 0 ? amt / maxDaily : 0;
            if(intensity <= 0.25) cls = 'level-1';
            else if(intensity <= 0.5) cls = 'level-2';
            else if(intensity <= 0.75) cls = 'level-3';
            else { cls = 'level-4'; maxDayNumber = d; }
         }
         html += `<div class="cal-day ${cls} ${amt>0?'has-data':''}" title="${d} de ${activeHormigaMonth}: ${fmt(amt)}">
           <span>${d}</span>
           ${amt>0 ? `<span style="font-size:0.55rem;opacity:0.8;margin-top:2px;">$${Math.round(amt)}</span>` : ''}
         </div>`;
      }
      html += '</div>';
      calContainer.innerHTML = html;

      // Actualizar resumen textual
      const keysWithData = allKeys.filter(k => totalHormigaMonth(k)>0); 
      const totalOverall = keysWithData.reduce((a,k)=>a+totalHormigaMonth(k),0);
      const activeTotal = totalHormigaMonth(activeHormigaKey);
      const activeHasData = activeTotal > 0;
      
      const sum = document.getElementById('hormiga-summary');
      if(sum) sum.innerHTML = `
        <div class="health-row"><span class="label">Total hist√≥rico (${allKeys.length} meses)</span><span class="val" style="color:var(--hormiga)">${fmt(totalOverall)}</span></div>
        <div class="health-row"><span class="label">Promedio mensual</span><span class="val">${keysWithData.length>0?fmt(totalOverall/keysWithData.length):'$0.00'}</span></div>
        <div class="health-row"><span class="label" style="color:var(--text)">Gasto en ${keyToLabel(activeHormigaKey)}</span><span class="val" style="color:var(--hormiga)">${fmt(activeTotal)}</span></div>
        <div class="health-row"><span class="label">D√≠a m√°s caro del mes</span><span class="val" style="font-size:0.8rem;">${activeHasData ? `D√≠a ${maxDayNumber} (${fmt(maxDaily)})` : '‚Äî'}</span></div>
      `;
  }

  // 2. GR√ÅFICO DE DONA (Mantiene l√≥gica original)
  const ctx2 = document.getElementById('hormiga-cat-chart').getContext('2d');
  destroyChart(hormigaCatChart);
  const catMap = {}; (hormigaData[activeHormigaKey]||[]).forEach(e => { if (e.amount>0) catMap[e.cat||'Otro'] = (catMap[e.cat||'Otro']||0) + Number(e.amount); });
  const catLabels = Object.keys(catMap);
  const HORMIGA_PALETTE = ['#f59e0b','#fbbf24','#d97706','#b45309','#78350f','#fef3c7','#fde68a','#ec4899','#8b5cf6','#06b6d4'];
  hormigaCatChart = new Chart(ctx2, {
    type: 'doughnut', data: { labels: catLabels, datasets: [{ data: catLabels.map(k=>catMap[k]), backgroundColor: HORMIGA_PALETTE, borderColor:'#0a0e1a', borderWidth:3, hoverOffset:6 }] },
    options: { responsive:true, maintainAspectRatio:false, plugins: { legend:{position:'right',labels:{color:'#5a6a85',font:{family:'DM Mono',size:11},boxWidth:12,padding:10}}, tooltip:{callbacks:{label:c=>` ${c.label}: ${fmt(c.raw)}`}} } }
  });

  const periodLbl = document.getElementById('hormiga-cat-period-label'); if (periodLbl) periodLbl.textContent = keyToLabel(activeHormigaKey);
}

function renderCompareChart() {
  const fromVal = document.getElementById('cmp-from').value; const toVal = document.getElementById('cmp-to').value;
  if (!fromVal || !toVal || fromVal > toVal) { document.getElementById('cmp-summary').textContent = 'Selecciona un rango v√°lido.'; return; }
  const allKeys = sortedHormigaKeys().filter(k => k >= fromVal && k <= toVal);
  if (allKeys.length === 0) { document.getElementById('cmp-summary').textContent = 'Sin datos en ese rango.'; return; }
  const labels = allKeys.map(keyToLabel); const totals = allKeys.map(k => totalHormigaMonth(k));
  const allCats = [...new Set(allKeys.flatMap(k => (hormigaData[k]||[]).map(e=>e.cat||'Otro')))];
  const PALETTE = ['#f59e0b','#fbbf24','#a855f7','#06b6d4','#ec4899','#84cc16','#f43f5e','#fb923c'];
  const datasets = allCats.map((cat,ci) => ({ label: cat, data: allKeys.map(k => (hormigaData[k]||[]).filter(e=>(e.cat||'Otro')===cat).reduce((a,e)=>a+Number(e.amount||0),0)), backgroundColor: PALETTE[ci%PALETTE.length]+'99', borderColor: PALETTE[ci%PALETTE.length], borderWidth: 1, stack: 'cats', borderRadius: 3 }));

  const ctx = document.getElementById('hormiga-compare-chart').getContext('2d'); destroyChart(hormigaCompareChart);
  hormigaCompareChart = new Chart(ctx, {
    type: 'bar', data: { labels, datasets },
    options: { responsive:true, maintainAspectRatio:false, interaction:{mode:'index',intersect:false}, plugins:{ legend:{position:'top',labels:{color:'#5a6a85',font:{family:'DM Mono',size:10},boxWidth:10,padding:8}}, tooltip:{callbacks:{label:c=>` ${c.dataset.label}: ${fmt(c.raw)}`, footer: items => ` Total: ${fmt(items.reduce((a,i)=>a+i.raw,0))}`}} }, scales:{ x:{stacked:true,ticks:{color:'#5a6a85',font:{family:'DM Mono',size:10}},grid:{color:'#1e2d45'}}, y:{stacked:true,ticks:{color:'#5a6a85',font:{family:'DM Mono',size:10},callback:v=>'$'+(v/1000).toFixed(1)+'k'},grid:{color:'#1e2d45'}} } }
  });
  const totalRange = totals.reduce((a,v)=>a+v,0); const avg = totals.length>0 ? totalRange/totals.length : 0; const peak = labels[totals.indexOf(Math.max(...totals))];
  document.getElementById('cmp-summary').innerHTML = `<span style="color:var(--text)">Rango: <strong style="color:var(--hormiga)">${fmt(totalRange)}</strong> total &nbsp;¬∑&nbsp; Promedio: <strong>${fmt(avg)}/mes</strong> &nbsp;¬∑&nbsp; Mes m√°s caro: <strong style="color:var(--accent2)">${peak||'‚Äî'}</strong></span>`;
}

function renderCatChart() {
  const ctx = document.getElementById('cat-chart').getContext('2d'); destroyChart(catChart);
  const ct = catTotals(); const labels = Object.keys(ct);
  catChart = new Chart(ctx, {
    type:'doughnut', data:{ labels, datasets:[{ data:labels.map(k=>ct[k]), backgroundColor:labels.map(catColorByLabel), borderColor:'#0a0e1a', borderWidth:3, hoverOffset:8 }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{position:'right',labels:{color:'#5a6a85',font:{family:'DM Mono',size:11},boxWidth:12,padding:12}}, tooltip:{callbacks:{label:c=>` ${c.label}: ${fmt(c.raw)}/mes`}} } }
  });
  const ct2 = document.getElementById('cat-totals');
  if(ct2) ct2.innerHTML = labels.map(k=>`
    <div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border)">
      <span style="display:flex;align-items:center;gap:6px"><span style="width:8px;height:8px;border-radius:50%;background:${catColorByLabel(k)};display:inline-block"></span>${k}</span>
      <span style="font-family:'DM Serif Display',serif">${fmt(ct[k])}/mes</span>
    </div>`).join('');
}

function renderDistChart() {
  const ctx = document.getElementById('dist-chart').getContext('2d'); destroyChart(distChart);
  const fixed = totalMonthlyServices(); const debt = totalMonthlyDebt(); const hormiga = totalHormigaCurrent(); const salary = totalIncome();
  const libre = Math.max(0, salary - fixed - debt - hormiga);
  distChart = new Chart(ctx, {
    type:'pie', data:{ labels:['Gastos fijos','Cuotas TDC','Hormiga','Disponible'], datasets:[{data:[fixed,debt,hormiga,libre], backgroundColor:['#00e5ff44','#ff6b6b44','#f59e0b44','#6bcb7744'], borderColor:['#00e5ff','#ff6b6b','#f59e0b','#6bcb77'], borderWidth:2, hoverOffset:8}] },
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:'#5a6a85',font:{family:'DM Mono',size:11},boxWidth:12}},tooltip:{callbacks:{label:c=>` ${c.label}: ${fmt(c.raw)}`}}}}
  });
}

function renderDebtChart() {
  const ctx = document.getElementById('debt-chart').getContext('2d'); destroyChart(debtChart);
  debtChart = new Chart(ctx, {
    type:'bar', data:{ labels:debts.map(d=>d.name), datasets:[{label:'Deuda total',data:debts.map(d=>d.total),backgroundColor:debts.map(d=>d.color+'88'),borderColor:debts.map(d=>d.color),borderWidth:2,borderRadius:6}] },
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>` ${fmt(c.raw)}`}}}, scales:{x:{ticks:{color:'#5a6a85',font:{family:'DM Mono',size:11}},grid:{color:'#1e2d45'}},y:{ticks:{color:'#5a6a85',font:{family:'DM Mono',size:11},callback:v=>'$'+(v/1000).toFixed(0)+'k'},grid:{color:'#1e2d45'}}}}
  });
}

function renderProjChart() {
  const canvas = document.getElementById('proj-chart'); if(!canvas) return;
  const ctx = canvas.getContext('2d'); destroyChart(projChart);
  const projLabels = ['Inicio', ...Array.from({length:12},(_,i)=>getMonthLabel(i))];
  const datasets = debts.map(d => {
    let remaining = d.total; const vals = [d.total];
    const isMonthlyMode = d.mode === 'auto' && (d.autoSub||'months') === 'monthly';
    const sch = isMonthlyMode ? debtScheduleFromMonthly(d) : null;
    const maxMonths = d.mode === 'manual' ? d.monthlyAmounts.filter(v=>v>0).length : isMonthlyMode ? sch.months : d.months;
    for (let i = 0; i < 12; i++) {
      let pay = d.mode === 'manual' ? (d.monthlyAmounts[i] || 0) : isMonthlyMode ? (sch.schedule[i] || 0) : (d.months > 0 ? d.total / d.months : 0);
      if (i >= maxMonths || remaining <= 0) { vals.push(0); remaining = 0; } else { remaining = Math.max(0, remaining - pay); vals.push(parseFloat(remaining.toFixed(2))); }
    }
    return {label:d.name, data:vals, backgroundColor:d.color+'55', borderColor:d.color, borderWidth:2, borderRadius:4, borderSkipped:false};
  });
  projChart = new Chart(ctx, {
    type:'bar', data:{labels: projLabels, datasets},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false}, plugins:{legend:{position:'top',labels:{color:'#5a6a85',font:{family:'DM Mono',size:11},boxWidth:12,padding:12}},tooltip:{callbacks:{label:c=>` ${c.dataset.label}: ${fmt(c.raw)}`, footer: items => ` Total pendiente: ${fmt(items.reduce((a,i)=>a+i.raw,0))}`}}}, scales:{x:{ticks:{color:'#5a6a85',font:{family:'DM Mono',size:10},maxRotation:30},grid:{color:'#1e2d45'}},y:{ticks:{color:'#5a6a85',font:{family:'DM Mono',size:11},callback:v=>'$'+(v/1000).toFixed(1)+'k'},grid:{color:'#1e2d45'}}}}
  });
}

function renderAllExpensesChart() {
  const canvas = document.getElementById('all-expenses-chart');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  
  const showIng = document.getElementById('toggle-ingresos')?.checked;
  const showFij = document.getElementById('toggle-fijos')?.checked;
  const showTdc = document.getElementById('toggle-tdc')?.checked;
  const showHor = document.getElementById('toggle-hormiga')?.checked;

  ['ingresos','fijos','tdc','hormiga'].forEach(k => {
    const chk = document.getElementById('toggle-'+k);
    const lbl = document.getElementById('lbl-toggle-'+k);
    if(chk && lbl) {
       lbl.style.borderColor = chk.checked ? 'var(--accent)' : 'var(--border)';
       lbl.style.color = chk.checked ? 'var(--accent)' : 'var(--muted)';
       lbl.style.background = chk.checked ? 'rgba(0,229,255,0.05)' : 'var(--surface2)';
    }
  });

  const fromEl = document.getElementById('all-exp-from');
  const toEl = document.getElementById('all-exp-to');
  
  let startKey = fromEl.value || '2026-03';
  let endKey = toEl.value || '2027-08';
  if (startKey > endKey) { const temp = startKey; startKey = endKey; endKey = temp; }

  let currentKey = startKey;
  const monthKeys = [];
  const labels = [];
  let i = 0;
  while(currentKey <= endKey && i < 60) {
    monthKeys.push(currentKey);
    labels.push(keyToLabel(currentKey));
    currentKey = shiftKey(currentKey, 1);
    i++;
  }

  destroyChart(allExpensesChart);
  const datasets = [];

  const getRadius = (amt) => {
    if (!amt || amt <= 0) return 0;
    return Math.max(3, Math.min(35, Math.sqrt(amt) * 0.4));
  };

  if (showIng) {
    incomes.forEach(inc => {
      const data = monthKeys.map(() => inc.amount);
      datasets.push({ label: inc.name + ' (Ingreso)', data, backgroundColor: 'rgba(107,203,119,0.15)', borderColor: '#6bcb77', borderWidth: 2, pointRadius: 3, tension: 0.3, fill: false });
    });
  }

  if (showFij) {
    const fixedByMonth = monthKeys.map(() => totalMonthlyServices());
    datasets.push({ label: 'Gastos Fijos', data: fixedByMonth, backgroundColor: 'rgba(0,229,255,0.1)', borderColor: '#00e5ff', borderWidth: 2, pointRadius: 3, tension: 0.3, fill: false });
  }

  if (showTdc) {
    debts.forEach(d => {
      const data = [];
      const isMonthlyMode = d.mode === 'auto' && (d.autoSub||'months') === 'monthly';
      const sch = isMonthlyMode ? debtScheduleFromMonthly(d) : null;
      
      monthKeys.forEach((k) => {
         const [yr, mn] = k.split('-').map(Number);
         const offset = (yr - 2026) * 12 + (mn - 3);
         let pay = 0;
         if (offset >= 0) {
           if (d.mode === 'manual') pay = d.monthlyAmounts[offset] || 0;
           else if (isMonthlyMode) pay = sch.schedule[offset] || 0;
           else pay = offset < d.months ? (d.total/d.months) : 0;
         }
         data.push(pay);
      });
      datasets.push({ label: d.name + ' (TDC)', data, backgroundColor: d.color+'22', borderColor: d.color, borderWidth: 2, pointRadius: 3, tension: 0.3, fill: false });
    });
  }

  if (showHor) {
    const hKeys = sortedHormigaKeys().filter(k=>totalHormigaMonth(k)>0);
    const hAvg = hKeys.length ? hKeys.reduce((a,k)=>a+totalHormigaMonth(k),0)/hKeys.length : 0;
    
    const data = monthKeys.map((k) => {
      return hormigaData[k] ? totalHormigaMonth(k) : hAvg;
    });
    datasets.push({ label: 'Hormiga (Mes/Promedio)', data, backgroundColor: 'rgba(245,158,11,0.15)', borderColor: 'var(--hormiga)', borderWidth: 2, pointRadius: 3, tension: 0.3, fill: false });
  }

  allExpensesChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: { 
        legend: { position: 'bottom', labels: { color: '#5a6a85', font: { family: 'DM Mono', size: 10 }, boxWidth: 12, padding: 10 } }, 
        tooltip: { callbacks: { label: c => ` ${c.dataset.label}: ${fmt(c.raw)}` } } 
      },
      scales: { 
        x: { ticks: { color: '#5a6a85', font: { family: 'DM Mono', size: 10 }, maxRotation: 45 }, grid: { color: '#1e2d45' } }, 
        y: { ticks: { color: '#5a6a85', font: { family: 'DM Mono', size: 10 }, callback: v => '$' + (v / 1000).toFixed(1) + 'k' }, grid: { color: '#1e2d45' } } 
      }
    }
  });
}

function renderTimeline() {
  const grid = document.getElementById('timeline-grid'); if(!grid) return; grid.innerHTML = '';
  
  const fromEl = document.getElementById('tl-from');
  const toEl = document.getElementById('tl-to');
  let startKey = fromEl && fromEl.value ? fromEl.value : '2026-03';
  let endKey = toEl && toEl.value ? toEl.value : '2027-02';
  if (startKey > endKey) { const t = startKey; startKey = endKey; endKey = t; }

  const months = [];
  let cur = startKey; let i = 0;
  while(cur <= endKey && i < 60) {
    const [yr, mn] = cur.split('-').map(Number);
    months.push({y: yr, m: mn, label: keyToLabel(cur), key: cur});
    cur = shiftKey(cur, 1); i++;
  }

  const gridCols = `160px repeat(${months.length}, minmax(60px, 1fr))`;

  const hdr = document.createElement('div'); hdr.className = 'timeline-header';
  hdr.style.gridTemplateColumns = gridCols;
  hdr.innerHTML = '<div style="padding:8px 10px;font-size:0.65rem;color:var(--muted);text-transform:uppercase">Tarjeta</div>' + months.map(m=>`<div>${m.label}</div>`).join('');
  grid.appendChild(hdr);

  debts.forEach(d => {
    const row = document.createElement('div'); row.className = 'timeline-row';
    row.style.gridTemplateColumns = gridCols;
    let cells = `<div class="timeline-row-name"><span style="width:10px;height:10px;border-radius:50%;background:${d.color};flex-shrink:0"></span>${d.name}</div>`;
    months.forEach(m => {
      const offset = (m.y - 2026) * 12 + (m.m - 3);
      let pay = 0, active = false, done = false;
      if(offset >= 0) {
        if (d.mode === 'manual') { 
          pay = d.monthlyAmounts[offset] || 0; 
          active = pay > 0; 
          done = offset >= d.monthlyAmounts.filter(v=>v>0).length;
        } else { 
          const isMonthlyMode = d.mode === 'auto' && (d.autoSub||'months') === 'monthly';
          if (isMonthlyMode) {
              const sch = debtScheduleFromMonthly(d);
              pay = sch.schedule[offset] || 0;
              active = pay > 0;
              done = offset >= sch.months;
          } else {
              pay = offset < d.months ? d.total / d.months : 0; 
              active = offset < d.months; 
              done = offset >= d.months;
          }
        }
      }
      let cls = 'timeline-cell cell-empty', label = '‚Äî';
      if (active && pay > 0) { cls = 'timeline-cell cell-active'; label = fmt(pay).replace('$',''); } else if (done) { cls = 'timeline-cell cell-done'; label = '‚úì'; }
      cells += `<div class="${cls}">${label}</div>`;
    });
    row.innerHTML = cells; grid.appendChild(row);
  });

  const totalRow = document.createElement('div'); totalRow.className = 'timeline-row'; totalRow.style.background = 'rgba(0,229,255,0.04)';
  totalRow.style.gridTemplateColumns = gridCols;
  let tCells = `<div class="timeline-row-name" style="color:var(--accent)">Total TDC</div>`;
  months.forEach((m) => {
    const offset = (m.y - 2026) * 12 + (m.m - 3);
    let t = 0;
    if(offset >= 0) {
        t = debts.reduce((acc, d) => {
          if (d.mode==='manual') return acc + (d.monthlyAmounts[offset]||0);
          const isMonthlyMode = d.mode === 'auto' && (d.autoSub||'months') === 'monthly';
          if (isMonthlyMode) { const sch = debtScheduleFromMonthly(d); return acc + (sch.schedule[offset]||0); }
          return offset < d.months ? acc + (d.total/d.months) : acc;
        }, 0);
    }
    tCells += `<div class="timeline-cell" style="color:var(--accent);font-weight:500">${t>0?fmt(t).replace('$',''):'‚Äî'}</div>`;
  });
  totalRow.innerHTML = tCells; grid.appendChild(totalRow);

  renderTimelineMonthlyChart(months);
}

function renderTimelineMonthlyChart(months) {
  const ctx = document.getElementById('timeline-monthly-chart').getContext('2d'); destroyChart(timelineMonthlyChart);
  const fixed = totalMonthlyServices(); const mLabels = months.map(m=>m.label);

  const debtMonthly = months.map((m) => {
    const offset = (m.y - 2026) * 12 + (m.m - 3);
    if(offset < 0) return 0;
    return debts.reduce((acc,d)=>{
      if (d.mode==='manual') return acc+(d.monthlyAmounts[offset]||0);
      const isMonthlyMode = d.mode === 'auto' && (d.autoSub||'months') === 'monthly';
      if (isMonthlyMode) { const sch = debtScheduleFromMonthly(d); return acc + (sch.schedule[offset]||0); }
      return offset<d.months ? acc+(d.total/d.months) : acc;
    },0);
  });
  const hormigaMonthly = months.map(m => totalHormigaMonth(m.key));
  const fixedArr = months.map(()=>fixed);

  timelineMonthlyChart = new Chart(ctx, {
    type:'bar', data:{ labels: mLabels, datasets:[ {label:'Gastos fijos',data:fixedArr,backgroundColor:'rgba(0,229,255,0.3)',borderColor:'#00e5ff',borderWidth:1,stack:'total'}, {label:'Cuotas TDC',data:debtMonthly,backgroundColor:'rgba(255,107,107,0.4)',borderColor:'#ff6b6b',borderWidth:1,stack:'total'}, {label:'Hormiga',data:hormigaMonthly,backgroundColor:'rgba(245,158,11,0.4)',borderColor:'#f59e0b',borderWidth:1,stack:'total'}, ] },
    options:{ responsive:true, maintainAspectRatio:false, interaction:{mode:'index',intersect:false}, plugins:{ legend:{position:'top',labels:{color:'#5a6a85',font:{family:'DM Mono',size:11},boxWidth:12}}, tooltip:{callbacks:{label:c=>` ${c.dataset.label}: ${fmt(c.raw)}`}} }, scales:{ x:{stacked:true,ticks:{color:'#5a6a85',font:{family:'DM Mono',size:10}},grid:{color:'#1e2d45'}}, y:{stacked:true,ticks:{color:'#5a6a85',font:{family:'DM Mono',size:11},callback:v=>'$'+(v/1000).toFixed(1)+'k'},grid:{color:'#1e2d45'}} } }
  });

  const totals = months.map((m,i)=>({ month:m.label, total: fixedArr[i]+debtMonthly[i]+hormigaMonthly[i], debt:debtMonthly[i], hormiga:hormigaMonthly[i] }));
  const sorted = [...totals].sort((a,b)=>b.total-a.total);
  const heaviest = document.getElementById('timeline-heaviest');
  if(heaviest) heaviest.innerHTML = sorted.slice(0,4).map((t,i)=>`<div class="health-row"><span class="label">${i===0?'üî¥':i===1?'üü†':'üü°'} ${t.month}</span><span class="val" style="color:${i===0?'var(--danger)':i===1?'var(--warning)':'var(--text)'}">${fmt(t.total)}</span></div>`).join('');

  const biggest = document.getElementById('timeline-biggest');
  if(biggest) biggest.innerHTML = months.slice(0,6).map((m,i)=>{
    const offset = (m.y - 2026) * 12 + (m.m - 3);
    let items = [{ name:'Fijos', val: fixed, color:'#00e5ff' }];
    if(offset >= 0) {
        const activeDebts = debts.filter(d=> {
          if(d.mode==='manual') return (d.monthlyAmounts[offset]||0)>0;
          const isMonthlyMode = d.mode === 'auto' && (d.autoSub||'months') === 'monthly';
          if(isMonthlyMode) return (debtScheduleFromMonthly(d).schedule[offset]||0)>0;
          return offset<d.months;
        }).map(d=>({ name:d.name, val: d.mode==='manual'?(d.monthlyAmounts[offset]||0) : ((d.autoSub||'months')==='monthly'?(debtScheduleFromMonthly(d).schedule[offset]||0) : (d.total/d.months)), color:d.color }));
        items = [...activeDebts, ...items];
    }
    const top = items.sort((a,b)=>b.val-a.val)[0];
    return `<div class="health-row"><span class="label">${m.label}</span><span class="val" style="font-size:0.82rem;color:${top?.color||'var(--muted)'}">${top?.name||'‚Äî'} ¬∑ ${fmt(top?.val||0)}</span></div>`;
  }).join('');
}

function renderHealthCompareChart() {
  const fromEl = document.getElementById('health-cmp-from');
  const toEl = document.getElementById('health-cmp-to');
  let startKey = fromEl && fromEl.value ? fromEl.value : '2026-03';
  let endKey = toEl && toEl.value ? toEl.value : '2026-05';
  if (startKey > endKey) { const t = startKey; startKey = endKey; endKey = t; }

  const canvas = document.getElementById('health-compare-chart'); if(!canvas) return;
  const ctx = canvas.getContext('2d'); destroyChart(healthCompareChart);

  const fixed = totalMonthlyServices();
  const labels = []; const dataFixed = []; const dataDebt = []; const dataHormiga = [];

  let cur = startKey;
  let i = 0;
  while(cur <= endKey && i < 36) {
    labels.push(keyToLabel(cur));
    dataFixed.push(fixed);
    
    const [yr, mn] = cur.split('-').map(Number);
    const offset = (yr - 2026) * 12 + (mn - 3);

    let debtMonth = 0;
    if(offset >= 0) {
      debtMonth = debts.reduce((acc,dItem)=>{
        if (dItem.mode==='manual') return acc+(dItem.monthlyAmounts[offset]||0);
        const isMonthlyMode = dItem.mode === 'auto' && (dItem.autoSub||'months') === 'monthly';
        if (isMonthlyMode) { const sch = debtScheduleFromMonthly(dItem); return acc + (sch.schedule[offset]||0); }
        return offset<dItem.months ? acc+(dItem.total/dItem.months) : acc;
      },0);
    }
    dataDebt.push(debtMonth);
    dataHormiga.push(totalHormigaMonth(cur));
    
    cur = shiftKey(cur, 1);
    i++;
  }

  healthCompareChart = new Chart(ctx, {
    type:'bar', data:{ labels, datasets:[ {label:'Gastos fijos',data:dataFixed,backgroundColor:'rgba(0,229,255,0.8)'}, {label:'Cuotas TDC',data:dataDebt,backgroundColor:'rgba(255,107,107,0.8)'}, {label:'Hormiga',data:dataHormiga,backgroundColor:'rgba(245,158,11,0.8)'} ] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{position:'top',labels:{color:'#5a6a85',font:{family:'DM Mono',size:11},boxWidth:12}}, tooltip:{callbacks:{label:c=>` ${c.dataset.label}: ${fmt(c.raw)}`}} }, scales:{ x:{stacked:true,ticks:{color:'#5a6a85',font:{family:'DM Mono',size:10}},grid:{color:'#1e2d45'}}, y:{stacked:true,ticks:{color:'#5a6a85',font:{family:'DM Mono',size:11},callback:v=>'$'+(v/1000).toFixed(1)+'k'},grid:{color:'#1e2d45'}} } }
  });
}

function renderHealthRing() {
  const salary = totalIncome(); const total = totalMonthlyServices() + totalMonthlyDebt() + totalHormigaCurrent();
  const pct = salary > 0 ? Math.min(100, total/salary*100) : 0;
  const hpct = document.getElementById('health-pct'); if(hpct) hpct.textContent = pct.toFixed(0)+'%';
  const canvas = document.getElementById('health-ring-chart'); if(!canvas) return;
  const ctx = canvas.getContext('2d'); destroyChart(healthRingChart);
  const color = pct<50?'#2ed573':pct<80?'#ffa502':'#ff4757';
  healthRingChart = new Chart(ctx,{type:'doughnut',data:{datasets:[{data:[pct,100-pct],backgroundColor:[color,'#1a2235'],borderWidth:0,circumference:270,rotation:-135}]},options:{responsive:false,cutout:'80%',plugins:{legend:{display:false},tooltip:{enabled:false}},animation:{duration:600}}});
  if(hpct) hpct.style.color = color;
}

function renderHealth() {
  const salary = totalIncome(); const fixed = totalMonthlyServices(); const debt = totalMonthlyDebt(); const hormiga = totalHormigaCurrent();
  const total = fixed + debt + hormiga; const libre = salary - total; const pct = salary > 0 ? (total/salary*100) : 0;
  renderHealthRing();
  const hd = document.getElementById('health-details'); if(hd) hd.innerHTML = `
    <div class="health-row"><span class="label">Gastos fijos/mes</span><span class="val" style="color:var(--accent)">${fmt(fixed)}</span></div>
    <div class="health-row"><span class="label">Gastos hormiga</span><span class="val" style="color:var(--hormiga)">${fmt(hormiga)}</span></div>
    <div class="health-row"><span class="label">Cuotas TDC/mes</span><span class="val" style="color:var(--accent2)">${fmt(debt)}</span></div>
    <div class="health-row"><span class="label">Total comprometido</span><span class="val" style="color:var(--accent3)">${fmt(total)}</span></div>
    <div class="health-row"><span class="label">Disponible</span><span class="val" style="color:${libre>=0?'var(--accent4)':'var(--danger)'}">${fmt(libre)}</span></div>`;

  const mc = document.getElementById('metrics-container'); if(mc) mc.innerHTML = `
    <div class="health-row"><span class="label">Deuda total TDC</span><span class="val" style="color:var(--accent2)">${fmt(totalDebt())}</span></div>
    <div class="health-row"><span class="label">Fijos anuales</span><span class="val">${fmt(fixed*12)}</span></div>
    <div class="health-row"><span class="label">% ingreso en TDC</span><span class="val" style="color:var(--accent2)">${salary>0?(debt/salary*100).toFixed(1):'‚Äî'}%</span></div>
    <div class="health-row"><span class="label">% ingreso en fijos</span><span class="val" style="color:var(--accent)">${salary>0?(fixed/salary*100).toFixed(1):'‚Äî'}%</span></div>
    <div class="health-row"><span class="label">% ingreso hormiga</span><span class="val" style="color:var(--hormiga)">${salary>0?(hormiga/salary*100).toFixed(1):'‚Äî'}%</span></div>
    <div class="health-row"><span class="label">Meses hasta 0 deuda</span><span class="val">${debts.length>0?Math.max(...debts.map(d=>{ if(d.mode==='manual') return d.monthlyAmounts.filter(v=>v>0).length; if((d.autoSub||'months')==='monthly') return debtScheduleFromMonthly(d).months; return d.months; })):0} meses</span></div>`;

  const recs = [];
  if (!salary) recs.push({t:'warning',i:'‚ö†Ô∏è',txt:'Agrega ingresos en la pesta√±a "Ingresos" para ver el an√°lisis completo.'});
  if (pct>80) recs.push({t:'danger',i:'üî¥',txt:`Comprometiste el <strong>${pct.toFixed(0)}%</strong> de tu ingreso. Considera renegociar plazos o cancelar suscripciones.`});
  else if (pct>60) recs.push({t:'warning',i:'üü°',txt:`<strong>${pct.toFixed(0)}%</strong> comprometido. Lo ideal es estar por debajo del 60%.`});
  else if (salary>0) recs.push({t:'success',i:'üü¢',txt:`Carga financiera manejable (${pct.toFixed(0)}%). Buen trabajo.`});
  const streaming = catTotals()['streaming']||0;
  if (streaming>500) recs.push({t:'warning',i:'üì∫',txt:`<strong>${fmt(streaming)}/mes</strong> en streaming. ¬øUsas todos activamente?`});
  const allHKeys = sortedHormigaKeys(); const hormigaAvg = allHKeys.filter(k=>totalHormigaMonth(k)>0).length;
  if (hormigaAvg>0) { const avgH = allHKeys.reduce((a,k)=>a+totalHormigaMonth(k),0)/hormigaAvg; if (avgH>1000) recs.push({t:'warning',i:'üêú',txt:`Promedio de gastos hormiga: <strong>${fmt(avgH)}/mes</strong>. Estos peque√±os gastos suman.`}); }
  const hsbc = debts.find(d=>d.name==='HSBC');
  if (hsbc) recs.push({t:'success',i:'üí°',txt:`HSBC es tu deuda m√°s grande (${fmt(hsbc.total)}). Pagar extra reduce significativamente intereses.`});

  const recEl = document.getElementById('recommendations');
  if(recEl) recEl.innerHTML = recs.map(r=>`<div class="alert alert-${r.t}" style="margin-bottom:10px"><span>${r.i}</span><span>${r.txt}</span></div>`).join('') || '<div style="color:var(--muted);font-size:0.82rem">Sin datos suficientes.</div>';
}

function updateKPIs() {
  const salary = totalIncome(); const fixed = totalMonthlyServices(); const debt = totalMonthlyDebt(); const hormiga = totalHormigaCurrent();
  const total = fixed + debt + hormiga; const libre = salary - total; const pct = salary>0?(total/salary*100):0;
  document.getElementById('kpi-fixed').textContent = fmt(fixed);
  document.getElementById('kpi-hormiga').textContent = fmt(hormiga);
  document.getElementById('kpi-hormiga-sub').textContent = activeHormigaMonth;
  document.getElementById('kpi-debt').textContent = fmt(debt);
  document.getElementById('kpi-total').textContent = fmt(total);
  document.getElementById('kpi-pct').textContent = salary>0?`${pct.toFixed(1)}% de tu ingreso`:'Suma de ingresos en $0';
  document.getElementById('kpi-free').textContent = salary>0?fmt(libre):'‚Äî';
  document.getElementById('kpi-free-sub').textContent = salary>0?(libre<0?'‚ö†Ô∏è D√©ficit mensual':'despu√©s de todos los compromisos'):'Ingresa tus fuentes de dinero';
  document.getElementById('kpi-free').style.color = libre>=0?'var(--accent4)':'var(--danger)';
  // Live month label
  const now = new Date();
  const MONTHS_ES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const monthLabel = MONTHS_ES[now.getMonth()];
  const m1 = document.getElementById('kpi-month-label'); if(m1) m1.textContent = monthLabel;
  const m2 = document.getElementById('kpi-month-label2'); if(m2) m2.textContent = monthLabel;
  
  const alertEl = document.getElementById('health-alert');
  if (salary>0 && libre<0) { alertEl.style.display='flex'; alertEl.className='alert alert-danger'; alertEl.innerHTML=`<div class="dot" style="background:var(--danger)"></div><strong>D√©ficit mensual de ${fmt(Math.abs(libre))}</strong>. Tus compromisos superan tu ingreso.`; }
  else if (salary>0 && pct>70) { alertEl.style.display='flex'; alertEl.className='alert alert-warning'; alertEl.innerHTML=`<div class="dot" style="background:var(--warning)"></div>Comprometiste el <strong>${pct.toFixed(0)}%</strong> de tu ingreso. Lo recomendable es no superar el 70%.`; }
  else if (salary>0) { alertEl.style.display='flex'; alertEl.className='alert alert-success'; alertEl.innerHTML=`<div class="dot" style="background:var(--success)"></div>Tienes disponibles <strong>${fmt(libre)}</strong> al mes (${(100-pct).toFixed(0)}% libre).`; }
  else { alertEl.style.display='none'; }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  L√çNEA DE TIEMPO DE PAGOS MENSUALES (top de Gr√°ficas)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _payTlKey = '2026-03';

function shiftPayTimeline(delta) {
  _payTlKey = shiftKey(_payTlKey, delta);
  renderPayTimeline();
}

function renderPayTimeline() {
  const labelEl = document.getElementById('pay-tl-month-label');
  const rowEl = document.getElementById('pay-tl-months-row');
  const summaryEl = document.getElementById('pay-tl-summary');
  if (!labelEl || !rowEl || !summaryEl) return;

  const startKey = shiftKey(_payTlKey, -2);
  const monthKeys = [];
  for (let i = 0; i < 12; i++) monthKeys.push(shiftKey(startKey, i));

  labelEl.textContent = keyToLabel(_payTlKey);
  const fixed = totalMonthlyServices();

  const getMonthTotal = (key) => {
    const [yr, mn] = key.split('-').map(Number);
    const offset = (yr - 2026) * 12 + (mn - 3);
    if (offset < 0) return { debt: 0, fixed, hormiga: 0, total: fixed };
    const debt = debts.reduce((acc, d) => {
      if (d.mode === 'manual') return acc + (d.monthlyAmounts[offset] || 0);
      const isMonthlyMode = d.mode === 'auto' && (d.autoSub || 'months') === 'monthly';
      if (isMonthlyMode) { const sch = debtScheduleFromMonthly(d); return acc + (sch.schedule[offset] || 0); }
      return offset < d.months ? acc + (d.total / d.months) : acc;
    }, 0);
    const hormiga = totalHormigaMonth(key);
    return { debt, fixed, hormiga, total: debt + fixed + hormiga };
  };

  const active = getMonthTotal(_payTlKey);
  const salary = totalIncome();
  const libre = salary - active.total;

  summaryEl.innerHTML = [
    { label: 'Gastos Fijos', val: active.fixed, color: 'var(--accent)' },
    { label: 'Cuotas TDC', val: active.debt, color: 'var(--accent2)' },
    { label: 'Hormiga', val: active.hormiga, color: 'var(--hormiga)' },
    { label: 'Total comprometido', val: active.total, color: 'var(--accent3)' },
    { label: salary > 0 ? 'Disponible' : 'Ingreso no definido', val: libre, color: libre >= 0 ? 'var(--accent4)' : 'var(--danger)' },
  ].map(item => `
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px;">
      <div style="font-size:0.62rem;text-transform:uppercase;letter-spacing:0.08em;color:var(--muted);margin-bottom:6px;">${item.label}</div>
      <div style="font-family:'DM Serif Display',serif;font-size:1.25rem;color:${item.color};line-height:1;">${salary > 0 || item.label !== 'Disponible' ? fmt(item.val) : '‚Äî'}</div>
    </div>`).join('');

  const allTotals = monthKeys.map(k => getMonthTotal(k).total);
  const maxTotal = Math.max(...allTotals, 1);

  rowEl.innerHTML = monthKeys.map(key => {
    const isActive = key === _payTlKey;
    const mt = getMonthTotal(key);
    const fixedPct = mt.total > 0 ? Math.round((mt.fixed / mt.total) * 100) : 0;
    const debtPct = mt.total > 0 ? Math.round((mt.debt / mt.total) * 100) : 0;
    const horPct = Math.max(0, 100 - fixedPct - debtPct);

    return `<div onclick="(()=>{_payTlKey='${key}';renderPayTimeline();})()" style="
      min-width:118px; flex:0 0 auto;
      background:${isActive ? 'var(--surface2)' : 'var(--surface)'};
      border:1px solid ${isActive ? 'var(--accent3)' : 'var(--border)'};
      border-radius:10px; padding:12px 10px; cursor:pointer;
      transition:border-color 0.2s,transform 0.15s;
      transform:${isActive ? 'translateY(-3px)' : 'translateY(0)'};
    ">
      <div style="font-size:0.62rem;text-transform:uppercase;letter-spacing:0.07em;color:${isActive ? 'var(--accent3)' : 'var(--muted)'};margin-bottom:6px;text-align:center;">${keyToLabel(key)}</div>
      <div style="font-family:'DM Serif Display',serif;font-size:0.95rem;color:${isActive ? 'var(--accent3)' : 'var(--text)'};text-align:center;margin-bottom:8px;">${fmt(mt.total)}</div>
      <div style="height:6px;border-radius:3px;overflow:hidden;display:flex;gap:1px;margin-bottom:6px;">
        <div style="width:${fixedPct}%;background:var(--accent);opacity:0.85;border-radius:3px 0 0 3px;"></div>
        <div style="width:${debtPct}%;background:var(--accent2);opacity:0.85;"></div>
        <div style="width:${horPct}%;background:var(--hormiga);opacity:0.85;border-radius:0 3px 3px 0;"></div>
      </div>
      <div style="font-size:0.58rem;color:var(--muted);text-align:center;">${mt.debt>0?fmt(mt.debt)+' TDC':mt.total>0?fmt(mt.fixed)+' fijo':'sin pagos'}</div>
    </div>`;
  }).join('');
}


function recalculate() {
  renderIncomes(); 
  renderServices();
  renderDebts();
  renderTdcCalendar();
  updateKPIs();
  renderCatChart();
  renderDistChart();
  renderDebtChart();
  renderProjChart();
  renderAllExpensesChart(); 
  renderTimeline();
  renderPayTimeline();
  renderHormigaMonths();
  renderHormigaCatBadges();
  renderHormigaEntries();
  renderHormigaCharts();
  // Initialize date input for hormiga form
  const _dateEl = document.getElementById('hormiga-date-input');
  if (_dateEl) {
    const _today = new Date();
    const _todayKey = `${_today.getFullYear()}-${String(_today.getMonth()+1).padStart(2,'0')}`;
    _dateEl.value = _todayKey === activeHormigaKey ? `${activeHormigaKey}-${String(_today.getDate()).padStart(2,'0')}` : '';
    _dateEl.min = `${activeHormigaKey}-01`;
    const [_yr, _mn] = activeHormigaKey.split('-').map(Number);
    _dateEl.max = `${activeHormigaKey}-${String(new Date(_yr, _mn, 0).getDate()).padStart(2,'0')}`;
  }
  renderHealthCompareChart(); 
  renderHealth();
  
  saveData();
}

// switchTab es alias de goToTab ‚Äî definido arriba junto a goToTab

// Inicializar fechas
const allExpFromEl = document.getElementById('all-exp-from');
const allExpToEl = document.getElementById('all-exp-to');
if(allExpFromEl && !allExpFromEl.value) allExpFromEl.value = '2026-03';
if(allExpToEl && !allExpToEl.value) allExpToEl.value = '2027-08';

const tlFromEl = document.getElementById('tl-from');
const tlToEl = document.getElementById('tl-to');
if(tlFromEl && !tlFromEl.value) tlFromEl.value = '2026-03';
if(tlToEl && !tlToEl.value) tlToEl.value = '2027-02';

const hCmpFromEl = document.getElementById('health-cmp-from');
const hCmpToEl = document.getElementById('health-cmp-to');
if(hCmpFromEl && !hCmpFromEl.value) hCmpFromEl.value = '2026-03';
if(hCmpToEl && !hCmpToEl.value) hCmpToEl.value = '2026-05';

document.getElementById('date-badge').textContent = new Date().toLocaleDateString('es-MX',{year:'numeric',month:'long',day:'numeric'});
recalculate();
</script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('Service Worker registrado con √©xito.', reg))
        .catch(err => console.log('Error al registrar el Service Worker.', err));
    });
  }
</script>
</body>
</html>
